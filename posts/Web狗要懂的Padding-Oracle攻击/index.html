<!DOCTYPE html>
<html lang="pt">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Web狗要懂的Padding Oracle攻击 | Pr0ph3t's blog</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="/assets/css/bootstrap-3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->

    <script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-69613510-1', 'auto');
    ga('send', 'pageview');

</script>


    <link rel="shortcut icon" href="/assets/images/favicon.png">

    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed/"> 

</head>


    <body>
      <div class="container">

        <header class="row">
  <div class="col-lg-8 col-lg-offset-2">
    <h1 class="">Pr0ph3t</h1>
    <p>
    <span class="reserved">char</span> nick[<span class="number">9</span>] = <span class="string">"Pr0ph3t"</span>;
    </p>
    <p>
    printf(<a href="https://github.com/t3hp0rP" target="_blank"><span class="string">"https://github.com/<span class="reserved">%s\n</span>"</span></a>,nick);
    </p>
    <p>
    printf(<span class="string">"<span class="reserved">%s\x40</span>pr0ph3t<span class="reserved">\x2e\\\b</span>com<span class="reserved">\n</span>"</span>,<span class="string">"admin"</span>);
    </p>
    <!-- <p>
            printf(<a href="https://blog.pr0ph3t.com" target="_blank"><span class="string">"https://<span class="reserved">%s</span>.pr0ph3t.com<span class="reserved">\n</span>"</span></a>,nick);
        </p> -->
    <p>
    puts(<a href="/assets/misc/pubkey.gpg.txt" target="_blank"><span class="string">"91B6 191A C2C3 285C 201D  801B B5A3 6B56 8528 E140"</span></a>);
    </p>
  </div>
</header>

<div class="row">
  <div class="col-lg-8 col-lg-offset-2">
    <div class="menu">
      <ul>
          <li><a href="/">home</a></li>
          <li><a href="/articles/">articles</a></li>
          <li><a href="/friendlink">friends</a></li>
      </ul>
    </div>
  </div>
</div>



        <div class="row">
          <div class="col-lg-8 col-lg-offset-2">
            <main>
            <div class="post">

  <header class="post-header">
    <h1>Web狗要懂的Padding Oracle攻击</h1>
  </header>

  <article class="post-content">
  <div class="post">

  <header class="post-header">
    <p class="meta">
        Nov 9, 2017
        
        
        •
        <span><a href="/category/#CyberSecurity" class="reserved">CyberSecurity</a>,</span><span><a href="/category/#writeup" class="reserved">writeup</a>,</span><span><a href="/category/#crypto" class="reserved">crypto</a>,</span><span><a href="/category/#old" class="reserved">old</a></span>
    </p>
  </header>

  <article class="post-content">
  <p>之前写CBC翻转攻击的时候就在想什么时候能遇到Padding Oracle的题目hhhhh 想不到这么快就遇到了hhhhh</p>

<hr>

<h2 id="part-654332bc5d8">题目</h2>

<p>题目ruby代码如下：</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#!/usr/bin/ruby -w</span>
<span class="nb">require</span> <span class="s1">'openssl'</span>
<span class="nb">require</span> <span class="s1">'base64'</span>

<span class="k">def</span> <span class="nf">banner</span><span class="p">()</span>
    <span class="nb">puts</span> <span class="s1">' ____________________________________________'</span>
    <span class="nb">puts</span> <span class="s1">'|                                            |'</span>
    <span class="nb">puts</span> <span class="s1">'| Welcome to our secure communication system |'</span>
    <span class="nb">puts</span> <span class="s1">'| Our system is secured by AES               |'</span>    
    <span class="nb">puts</span> <span class="s1">'| So...No key! No Message!                   |'</span>
    <span class="nb">puts</span> <span class="s1">'|____________________________________________|'</span>
    <span class="nb">puts</span> <span class="s1">''</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">option</span><span class="p">()</span>
    <span class="nb">puts</span> <span class="s1">'1. Get the secret message.'</span>
    <span class="nb">puts</span> <span class="s1">'2. Encrypt the message'</span>
    <span class="nb">puts</span> <span class="s1">'3. Decrypt the message.'</span>
    <span class="nb">puts</span> <span class="s1">'Give your option:'</span>
    <span class="no">STDOUT</span><span class="p">.</span><span class="nf">flush</span>
    <span class="n">op</span><span class="o">=</span><span class="nb">gets</span>
    <span class="k">return</span> <span class="n">op</span><span class="p">.</span><span class="nf">to_i</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">init</span><span class="p">()</span>
    <span class="n">file_key</span><span class="o">=</span><span class="no">File</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"./aeskey"</span><span class="p">,</span><span class="s2">"r"</span><span class="p">)</span>
    <span class="vg">$key</span><span class="o">=</span><span class="n">file_key</span><span class="p">.</span><span class="nf">gets</span>
    <span class="n">file_key</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
<span class="k">end</span>
<span class="k">def</span> <span class="nf">aes_encrypt</span><span class="p">(</span><span class="n">iv</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
    <span class="n">cipher</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">Cipher</span><span class="o">::</span><span class="no">AES</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="ss">:CBC</span><span class="p">)</span>
    <span class="n">cipher</span><span class="p">.</span><span class="nf">encrypt</span>
    <span class="n">cipher</span><span class="p">.</span><span class="nf">key</span> <span class="o">=</span> <span class="vg">$key</span>
    <span class="n">cipher</span><span class="p">.</span><span class="nf">iv</span>  <span class="o">=</span> <span class="n">iv</span>
    <span class="n">cipher</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">cipher</span><span class="p">.</span><span class="nf">final</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">aes_decrypt</span><span class="p">(</span><span class="n">iv</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
    <span class="n">cipher</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">Cipher</span><span class="o">::</span><span class="no">AES</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="ss">:CBC</span><span class="p">)</span>
    <span class="n">cipher</span><span class="p">.</span><span class="nf">decrypt</span>
    <span class="n">cipher</span><span class="p">.</span><span class="nf">key</span> <span class="o">=</span> <span class="vg">$key</span>
    <span class="n">cipher</span><span class="p">.</span><span class="nf">iv</span>  <span class="o">=</span> <span class="n">iv</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">cipher</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">cipher</span><span class="p">.</span><span class="nf">final</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">output_secret</span><span class="p">()</span>
    <span class="n">file_secret</span><span class="o">=</span><span class="no">File</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"./flag"</span><span class="p">,</span><span class="s2">"r"</span><span class="p">)</span>
    <span class="n">secret</span><span class="o">=</span><span class="n">file_secret</span><span class="p">.</span><span class="nf">gets</span>
    <span class="n">file_secret</span><span class="p">.</span><span class="nf">close</span>
    <span class="n">secret_enc</span><span class="o">=</span><span class="n">aes_encrypt</span><span class="p">(</span><span class="s2">"A"</span><span class="o">*</span><span class="mi">16</span><span class="p">,</span><span class="n">secret</span><span class="p">)</span>
    <span class="n">secret_enc_b64</span><span class="o">=</span><span class="no">Base64</span><span class="p">.</span><span class="nf">encode64</span><span class="p">(</span><span class="n">secret_enc</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="n">secret_enc_b64</span> 
<span class="k">end</span>

<span class="n">init</span>
<span class="n">banner</span>
<span class="k">while</span> <span class="kp">true</span> <span class="k">do</span>
    <span class="k">begin</span>
        <span class="n">op</span><span class="o">=</span><span class="n">option</span>
        <span class="k">if</span> <span class="n">op</span><span class="o">==</span><span class="mi">1</span>
            <span class="n">output_secret</span>
        <span class="k">elsif</span> <span class="n">op</span><span class="o">==</span><span class="mi">2</span>
            <span class="nb">puts</span> <span class="s2">"IV:"</span>
            <span class="no">STDOUT</span><span class="p">.</span><span class="nf">flush</span>
            <span class="n">iv</span><span class="o">=</span><span class="no">Base64</span><span class="p">.</span><span class="nf">decode64</span><span class="p">(</span><span class="nb">gets</span><span class="p">)</span>
            <span class="nb">puts</span> <span class="s2">"Data:"</span>
            <span class="no">STDOUT</span><span class="p">.</span><span class="nf">flush</span>
            <span class="n">data</span><span class="o">=</span><span class="no">Base64</span><span class="p">.</span><span class="nf">decode64</span><span class="p">(</span><span class="nb">gets</span><span class="p">)</span>
            <span class="n">data_enc</span><span class="o">=</span><span class="n">aes_encrypt</span> <span class="n">iv</span><span class="p">,</span><span class="n">data</span>
            <span class="nb">puts</span> <span class="no">Base64</span><span class="p">.</span><span class="nf">encode64</span><span class="p">(</span><span class="n">data_enc</span><span class="p">)</span>
            <span class="nb">puts</span> <span class="s2">"Encrytion Done"</span>    
            <span class="no">STDOUT</span><span class="p">.</span><span class="nf">flush</span>
        <span class="k">elsif</span> <span class="n">op</span><span class="o">==</span><span class="mi">3</span>
            <span class="nb">puts</span> <span class="s2">"IV:"</span>
            <span class="no">STDOUT</span><span class="p">.</span><span class="nf">flush</span>
            <span class="n">iv</span><span class="o">=</span><span class="no">Base64</span><span class="p">.</span><span class="nf">decode64</span><span class="p">(</span><span class="nb">gets</span><span class="p">)</span>
            <span class="nb">puts</span> <span class="s2">"Data:"</span>
            <span class="no">STDOUT</span><span class="p">.</span><span class="nf">flush</span>
            <span class="n">data</span><span class="o">=</span><span class="no">Base64</span><span class="p">.</span><span class="nf">decode64</span><span class="p">(</span><span class="nb">gets</span><span class="p">)</span>
            <span class="n">data_dec</span><span class="o">=</span><span class="n">aes_decrypt</span> <span class="n">iv</span><span class="p">,</span><span class="n">data</span>
            <span class="nb">puts</span> <span class="n">data_dec</span>
            <span class="nb">puts</span> <span class="s2">"Decrpytion Done"</span>
            <span class="no">STDOUT</span><span class="p">.</span><span class="nf">flush</span>
        <span class="k">else</span>
            <span class="nb">puts</span> <span class="s1">'Wrong Option'</span>
            <span class="no">STDOUT</span><span class="p">.</span><span class="nf">flush</span>
        <span class="k">end</span>
    <span class="k">rescue</span> <span class="no">Exception</span> <span class="o">=&gt;</span> <span class="n">e</span>  
        <span class="nb">puts</span> <span class="n">e</span><span class="p">.</span><span class="nf">message</span>
        <span class="no">STDOUT</span><span class="p">.</span><span class="nf">flush</span>
        <span class="k">retry</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>可以得出题目的基本信息：<br>
- 1选项：<br>
输出经过aes-256-cbc加密的flag<br>
- 2选项：<br>
提供你的IV和要加密的数据，返回加密后的密文<br>
- 3选项：<br>
提供你的IV和要解密的数据，<strong><em>不</em></strong>返回解密明文，只返回解密成功是否</p>

<p>我们可以从源码获取到的信息有：<br>
- 加密flag所采用的IV为16个字符<code class="prettyprint">A</code><br>
- 不能获取到加密flag所用的密钥<br>
- 解密时IV与密文可控</p>

<hr>

<h2 id="part-8137449e5e4e3e37">背景知识：</h2>

<ul>
<li>加密过程
<img src="/assets/images/posts/2017/Web%E7%8B%97%E8%A6%81%E6%87%82%E7%9A%84Padding-Oracle%E6%94%BB%E5%87%BB/1.png" alt="cbcEncrypt.png"></li>
<li>首先将明文分成每X位一组，位数不足的是用特殊字符填充！！！！！！！
X常见的为16位，也有32位
这里要注意，CBC的填充规则（有PKCS5和PKCS7，<a href="https://www.cnblogs.com/midea0978/articles/1437257.html">区别</a>这里使用的是PKCS7 图解如下）是缺少N位，就用 N 个 &#39;\xN&#39;填充，如缺少10位则用 10 个 &#39;\x10&#39;填充</li>
<li>然后生成初始向量IV(这里的初始向量如果未特定给出则随机生成)和密钥</li>
<li>将初始向量与第一组明文异或生成密文A</li>
<li>用密钥加密密文A 得到密文A_1</li>
<li>重复3 将密文A_1与第二组明文异或生成密文B</li>
<li>重复4 用密钥加密密文B_1</li>
<li>重复3-6 直到最后一组明文</li>
<li><p>将IV和加密后的密文拼接在一起，得到最终的密文(也可以不拼接)</p></li>
<li><p>解密过程<br>
<img src="/assets/images/posts/2017/Web%E7%8B%97%E8%A6%81%E6%87%82%E7%9A%84Padding-Oracle%E6%94%BB%E5%87%BB/2.png" alt="cbcDecrypt.png"><br>
解密过程则是相反的</p></li>
<li><p>首先从最终的密文中提取出IV (IV为加密时指定的X位) //如果加密时没有加入IV则不用提取</p></li>
<li><p>将密文分组</p></li>
<li><p>使用密钥对第一组密文解密得到密文A，然后用IV进行异或得到第一组明文</p></li>
<li><p>使用密钥对第二组密文解密得到密文B，然后用A与B进行异或得到第二组明文</p></li>
<li><p>重复3-4 直到最后一组密文</p></li>
</ul>

<hr>

<h2 id="part-6542b421b21">攻击</h2>

<p>与CBC翻转攻击不同的地方是 我们这里不知道解密之后的明文，只知道并可控IV和密文，对了 还有解密是否成功<br>
解密是否成功这个点成为了padding oracle攻击至关重要的一点，<br>
因为我们知道padding只能为：</p>
<div class="highlight"><pre><code class="language-" data-lang="">data 0x01 或
data 0x02 0x02 或
data 0x03 0x03 0x03 或
data 0x04 0x04 0x04 0x04 或
data 0x05 0x05 0x05 0x05 0x05 或
......
</code></pre></div>
<p>那如果出现以下这种padding的时候会怎么样呢？<br>
<code class="prettyprint">data 0x05 0x05</code><br>
（正常来说这个padding应为<code class="prettyprint">data 0x05 0x05 0x05 0x05 0x05</code>）<br>
那解密之后的检验就会出现错误，因为padding的位数和padding内容不一致<br>
如果这个服务没有catch这个错误的话那么程序就会中途报错退出，表现为，如http服务的status code为500<br>
那么这里就给了我们一个爆破的机会，假如在第一组解密中，我们输入解密的IV为16个0x00的话，解密过程就为：<br>
<img src="/assets/images/posts/2017/Web%E7%8B%97%E8%A6%81%E6%87%82%E7%9A%84Padding-Oracle%E6%94%BB%E5%87%BB/3.png" alt="00wrong.png"><br>
最后一位为0x3D，不符合padding规则<br>
我们将IV的最后一位递增，然后提交，在0x00到0xFF中，只会有一个异或middle最后一位之后会得到0x01，也就是正确的padding，这时候服务正常解密(只是解密出来的结果不是原来的明文而已)，则假设Plainttext为明文，middle为经过aes解密之后尚未和IV异或的值，IV[0]则为需要遍历爆破的十六进制，有<br>
<img src="/assets/images/posts/2017/Web%E7%8B%97%E8%A6%81%E6%87%82%E7%9A%84Padding-Oracle%E6%94%BB%E5%87%BB/4.png" alt="00true.png"></p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">//</span><span class="err">根据</span>
<span class="n">middle</span><span class="p">[</span><span class="err">最后一位</span><span class="p">]</span> <span class="o">^</span> <span class="n">IV</span><span class="p">[</span><span class="err">最后一位</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span>
<span class="n">middle</span><span class="p">[</span><span class="err">最后一位</span><span class="p">]</span> <span class="o">=</span> <span class="n">IV</span><span class="p">[</span><span class="err">最后一位</span><span class="p">]</span> <span class="o">^</span> <span class="mh">0x01</span>
<span class="o">//</span><span class="err">因为正常的解密步骤是</span><span class="n">middle</span><span class="err">异或加密时使用的</span><span class="n">old_IV</span><span class="err">，所以</span>
<span class="n">Plainttext</span><span class="p">[</span><span class="err">最后一位</span><span class="p">]</span> <span class="o">=</span> <span class="n">middle</span><span class="p">[</span><span class="err">最后一位</span><span class="p">]</span> <span class="o">^</span> <span class="n">old_IV</span><span class="p">[</span><span class="err">最后一位</span><span class="p">]</span>
</code></pre></div>
<p>到这里我们就能在不知道密钥的情况下爆破出最后一位的明文了<br>
接下来我们要爆破倒数第二位，后两位正确的padding应该是<br>
<code class="prettyprint">data 0x02 0x02</code><br>
首先我们得先把最后一位调整成0x02，所以</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">IV</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">middle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="mh">0x02</span>
<span class="o">//</span><span class="err">那么解密的时候</span><span class="n">middle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">IV</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">就会始终等于</span><span class="mh">0x02</span><span class="err">了</span>
</code></pre></div>
<p>然后继续从0x00爆破到0xFF，得到正确的解密提示之后将爆破得到的值异或old_IV[倒数第二位]就是Plainttext[倒数第二位了]<br>
以此类推.....</p>

<p>但是在解密第二组及其以后的组的时候有一个注意的地方，经过aes解密之后的middle要异或的不再是IV了，而是前一组密文！！</p>

<hr>

<h2 id="part-3786c91c7fb363f">坑点：</h2>

<ul>
<li>首先记得查看加密的初始IV是多少位，再根据这个位数将密文分组！按组爆破！</li>
<li>其次是IV是每爆破出一位最好都要重新根据middle生成爆破位后面的位数 （之前就是这个点坑了我一个通宵。。。。）</li>
</ul>

<hr>

<p>解题脚本 1:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">base64</span> <span class="k">as</span> <span class="n">b64</span>

<span class="n">IV</span> <span class="o">=</span> <span class="p">[</span><span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span>
<span class="n">secret</span> <span class="o">=</span> <span class="s">'nPQctp6AezY8BcGPjlYW8Pv+Fpo15LeatsVbj47jqgE='</span>
<span class="n">secret1</span> <span class="o">=</span> <span class="n">b64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">secret</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">16</span><span class="p">]</span>
<span class="n">secret2</span> <span class="o">=</span> <span class="n">b64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">secret</span><span class="p">)[</span><span class="mi">16</span><span class="p">:]</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">'10.188.2.20'</span><span class="p">,</span><span class="mi">10010</span><span class="p">)</span>
<span class="n">middle</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">pt</span> <span class="o">=</span> <span class="s">''</span>

<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">16</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">256</span><span class="p">):</span>
        <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Give your option:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'3'</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"IV:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">b64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">IV</span><span class="p">)))</span> <span class="c1">#send your IV
</span>        <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Data:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">b64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">secret1</span><span class="p">))</span> <span class="c1">#send your Data
</span>        <span class="c1"># p.sendline(b64.b64encode(secret2)) #send your Data
</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="c1"># print res
</span>        <span class="k">if</span> <span class="s">'bad decrypt'</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
            <span class="n">IV</span><span class="p">[</span><span class="mi">15</span><span class="o">-</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s">'Decrpytion Done'</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">IV</span>
            <span class="n">IV</span><span class="p">[</span><span class="mi">15</span><span class="o">-</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">IV</span><span class="p">[</span><span class="mi">15</span><span class="o">-</span><span class="n">x</span><span class="p">])</span> <span class="o">^</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="c1">#to get the correct middle, just like ---&gt; IV[0] ^ 0x01 = middle[0]
</span>            <span class="n">middle</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">IV</span><span class="p">[</span><span class="mi">15</span><span class="o">-</span><span class="n">x</span><span class="p">]))</span> <span class="c1">#store the correct middle
</span>            <span class="k">print</span> <span class="n">middle</span>
            <span class="n">pt</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">IV</span><span class="p">[</span><span class="mi">15</span><span class="o">-</span><span class="n">x</span><span class="p">])</span> <span class="o">^</span> <span class="nb">ord</span><span class="p">(</span><span class="s">'A'</span><span class="p">))</span> <span class="c1">#first plaint text
</span>            <span class="c1"># pt += chr(ord(IV[15-x]) ^ ord(secret1[15-x])) #second plaint text
</span>            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">IV</span><span class="p">[</span><span class="mi">15</span><span class="o">-</span><span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">middle</span><span class="p">[</span><span class="n">z</span><span class="p">]</span> <span class="o">^</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="c1">#generate the next new IV
</span>            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">res</span>
            <span class="nb">exit</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">255</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">'[!] Something wrong'</span>
            <span class="k">print</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="nb">exit</span><span class="p">()</span>

<span class="k">print</span> <span class="s">'[!] Final IV : '</span>
<span class="k">print</span> <span class="n">IV</span>
<span class="k">print</span> <span class="s">'[!] Get middle : '</span><span class="p">,</span> <span class="n">middle</span>
<span class="k">print</span> <span class="s">'[!] PlaintText is : '</span> <span class="o">+</span> <span class="n">pt</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div>
<p>解题脚本 2:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">base64</span> <span class="k">as</span> <span class="n">b64</span>

<span class="n">secret</span> <span class="o">=</span> <span class="s">'nPQctp6AezY8BcGPjlYW8Pv+Fpo15LeatsVbj47jqgE='</span>
<span class="n">secret1</span> <span class="o">=</span> <span class="n">b64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">secret</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">16</span><span class="p">]</span>
<span class="n">secret2</span> <span class="o">=</span> <span class="n">b64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">secret</span><span class="p">)[</span><span class="mi">16</span><span class="p">:]</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">'10.188.2.20'</span><span class="p">,</span><span class="mi">10010</span><span class="p">)</span>

<span class="n">middle</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">padding</span> <span class="o">=</span> <span class="s">''</span>

<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">17</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">256</span><span class="p">):</span>
        <span class="n">IV</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x00</span><span class="s">"</span> <span class="o">*</span> <span class="p">(</span><span class="mi">16</span><span class="o">-</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="n">padding</span>

        <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Give your option:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"3"</span><span class="p">)</span>

        <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"IV:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">b64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">IV</span><span class="p">))</span>

        <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Data:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">b64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">secret2</span><span class="p">))</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">'Decrpytion Done'</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
            <span class="n">middle</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span> <span class="o">^</span> <span class="n">x</span><span class="p">)</span> <span class="c1">#calculate and store the correct middle
</span>            <span class="k">print</span> <span class="n">middle</span>
            <span class="n">padding</span> <span class="o">=</span> <span class="s">''</span>
            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">middle</span><span class="p">:</span>
                <span class="n">padding</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">((</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="n">padding</span> <span class="c1">#generate the next new IV tail
</span>            <span class="k">break</span>

<span class="n">flag</span> <span class="o">=</span> <span class="s">""</span>
<span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">middle</span><span class="p">,</span><span class="n">secret1</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
    <span class="c1"># flag += chr(x ^ ord('A')) #for secret1
</span>    <span class="n">flag</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">x</span> <span class="o">^</span> <span class="nb">ord</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="c1">#for secret2
</span><span class="k">print</span> <span class="n">flag</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div>
<hr>

<p>作者水平有限 如有错误请指出 Orz</p>

<p>参考文章 :<br>
<a href="http://blog.zhaojie.me/2010/10/padding-oracle-attack-in-detail.html">http://blog.zhaojie.me/2010/10/padding-oracle-attack-in-detail.html</a><br>
<a href="http://www.jianshu.com/p/1851f778e579">http://www.jianshu.com/p/1851f778e579</a><br>
<a href="http://www.jianshu.com/p/9b4d3565de87">http://www.jianshu.com/p/9b4d3565de87</a></p>

  </article>

	<p class="feed-recomendation">
		Did you like the post? Subscribe to the <a href="/feed/">feed</a>.
	</p>

  <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'pr0ph3t';
    var disqus_config = function () {
        this.page.identifier = "/posts/Web%E7%8B%97%E8%A6%81%E6%87%82%E7%9A%84Padding-Oracle%E6%94%BB%E5%87%BB/";
    };
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>




</div>

  </article>

</div>

            </main>
          </div>
        </div>

        <div class="row">
  <div class="col-lg-8 col-lg-offset-2">
    <footer>
      Thx!
    </footer>
  </div>
</div>
<script src="//code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
$(document).ready(function() {
	$("img").each(function() {
		var strA = "<a data-fancybox='gallery' href='" + this.src + "'></a>";
		$(this).wrapAll(strA);
    });
});
</script>
<!-- <script type="text/javascript" src="/assets/js/images.js"></script> -->

      </div>
    </body>
</html>
